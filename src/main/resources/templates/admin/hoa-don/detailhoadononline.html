<!DOCTYPE html>
<html lang="vi" xmlns:th="http://www.thymeleaf.org" xmlns:layout="http://www.ultraq.net.nz/thymeleaf/layout"
    layout:decorate="~{layout/main}">

<link href="https://cdn.jsdelivr.net/npm/bootstrap@5.0.2/dist/css/bootstrap.min.css" rel="stylesheet"
    integrity="sha384-EVSTQN3/azprG1Anm3QDgpJLIm9Nao0Yz1ztcQTwFspd3yD65VohhpuuCOmLASjC" crossorigin="anonymous">
<script src="https://cdn.jsdelivr.net/npm/bootstrap@5.0.2/dist/js/bootstrap.bundle.min.js"
    integrity="sha384-MrcW6ZMFYlzcLA8Nl+NtUVF0sA7MsXsP1UyJoMp4YLEuNSfAP+JcXn/tWtIaxVXM"
    crossorigin="anonymous"></script>

<body>
    <div layout:fragment="content">
        <style>
            #modalSanPham .modal-content {
                border: none;
                border-radius: 10px;
                box-shadow: 0 5px 20px rgba(0, 0, 0, 0.1);
            }

            #modalSanPham .modal-header {
                border-radius: 10px 10px 0 0;
                padding: 1rem 1.5rem;
            }

            #modalSanPham .modal-body {
                padding: 1.5rem;
            }

            /* Table style */
            #modalSanPham .table {
                margin-bottom: 0;
            }

            #modalSanPham .table th {
                font-weight: 600;
                text-transform: uppercase;
                font-size: 0.8rem;
                letter-spacing: 0.5px;
                background-color: #f8f9fa !important;
            }

            #modalSanPham .table-danger td {
                color: #dc3545;
                opacity: 0.7;
            }

            /* Button style */
            #modalSanPham .btn-success {
                background-color: #28a745;
                border-color: #28a745;
                transition: all 0.3s;
            }

            #modalSanPham .btn-success:hover {
                background-color: #218838;
                border-color: #1e7e34;
            }

            /* Pagination style */
            #modalSanPham .page-item.active .page-link {
                background-color: #d3b788;
                border-color: #f5f5f5;
            }

            #modalSanPham .page-link {
                color: rgb(36, 34, 34);
            }

            /* Responsive */
            @media (max-width: 768px) {
                #modalSanPham .modal-body {
                    padding: 1rem;
                }

                #modalSanPham .table-responsive {
                    margin-bottom: 1rem;
                }
            }

            /* General card styles */
            .card {
                border: none;
                border-radius: 10px;
                box-shadow: 0 4px 12px rgba(0, 0, 0, 0.08);
                transition: all 0.3s ease;
                height: 100%;
            }

            .card:hover {
                box-shadow: 0 6px 16px rgba(0, 0, 0, 0.12);
            }

            .card-header {
                background-color: #fff;
                border-bottom: 1px solid rgba(0, 0, 0, 0.08);
                padding: 1.25rem 1.5rem;
                border-radius: 10px 10px 0 0 !important;
            }

            .card-header h5 {
                font-weight: 600;
                color: #2c3e50;
                font-size: 1.1rem;
                margin: 0;
            }

            .card-body {
                padding: 1.5rem;
            }

            /* Payment information section */
            .text-muted.small {
                font-size: 1rem;
                color: #6c757d !important;
                font-weight: 500;
                margin-bottom: 0.25rem;
                display: block;
            }

            .card-body p.mb-0 {
                font-size: 0.95rem;
                color: #495057;
                font-weight: 500;
                margin: 0;
            }

            /* Summary card styles */
            .summary-card {
                background-color: #f8fafc;
            }

            .summary-item {
                display: flex;
                justify-content: space-between;
                margin-bottom: 0.8rem;
                font-size: 0.95rem;
            }

            .summary-item span:first-child {
                color: #6c757d;
                font-weight: 500;
            }

            .summary-item span:last-child {
                color: #495057;
                font-weight: 600;
            }

            .summary-item.text-danger span {
                color: #dc3545 !important;
            }

            .summary-item.total-amount {
                margin-top: 1rem;
                padding-top: 0.8rem;
                border-top: 1px dashed #dee2e6;
            }

            .summary-item.total-amount span {
                font-size: 1.1rem;
                color: #2c3e50 !important;
                font-weight: 700;
            }

            hr {
                margin: 1.25rem 0;
                border-top: 1px dashed #e9ecef;
            }

            /* Payment status styles (đã có từ trước) */
            .payment-status-container {
                padding: 1rem;
                background-color: #f8f9fa;
                border-radius: 8px;
                border-left: 4px solid #6c757d;
            }

            .payment-status-label {
                font-weight: 600;
                color: #495057;
                text-transform: uppercase;
                font-size: 0.8rem;
                letter-spacing: 0.5px;
            }

            .payment-badge {
                display: inline-flex;
                align-items: center;
                padding: 0.5rem 1rem;
                border-radius: 20px;
                font-size: 0.9rem;
                font-weight: 500;
            }

            .payment-badge-success {
                background-color: #e6f7ee;
                color: #28a745;
                border: 1px solid #c3e6cb;
            }

            .payment-badge-warning {
                background-color: #fff3cd;
                color: #856404;
                border: 1px solid #ffeeba;
            }

            .payment-badge-danger {
                background-color: #fdecea;
                color: #dc3545;
                border: 1px solid #f5c6cb;
            }

            .payment-status-group {
                display: flex;
                flex-direction: column;
                gap: 0.5rem;
            }

            .payment-badge i {
                font-size: 1rem;
            }

            /* Responsive adjustments */
            @media (max-width: 768px) {
                .col-md-6 {
                    margin-bottom: 1.5rem;
                }

                .card-header {
                    padding: 1rem;
                }

                .card-body {
                    padding: 1.25rem;
                }

                .summary-item {
                    font-size: 0.9rem;
                }

                .summary-item.total-amount span {
                    font-size: 1rem;
                }
            }

            /* Payment status container */
            .payment-status-container {
                padding: 1rem;
                background-color: #f8f9fa;
                border-radius: 8px;
                border-left: 4px solid #6c757d;
            }

            .payment-status-label {
                font-weight: 600;
                color: #495057;
                text-transform: uppercase;
                font-size: 0.8rem;
                letter-spacing: 0.5px;
            }

            /* Payment badges */
            .payment-badge {
                display: inline-flex;
                align-items: center;
                padding: 0.5rem 1rem;
                border-radius: 20px;
                font-size: 0.9rem;
                font-weight: 500;
            }

            .payment-badge-success {
                background-color: #e6f7ee;
                color: #28a745;
                border: 1px solid #c3e6cb;
            }

            .payment-badge-warning {
                background-color: #fff3cd;
                color: #856404;
                border: 1px solid #ffeeba;
            }

            .payment-badge-danger {
                background-color: #fdecea;
                color: #dc3545;
                border: 1px solid #f5c6cb;
            }

            .payment-status-group {
                display: flex;
                flex-direction: column;
                gap: 0.5rem;
            }

            /* Icon styles */
            .payment-badge i {
                font-size: 1rem;
            }

            /* CSS tổng thể */
            .invoice-container {
                background-color: #f8f9fa;
                padding: 20px;
                border-radius: 10px;
            }

            .card {
                border: none;
                border-radius: 10px;
                box-shadow: 0 4px 12px rgba(0, 0, 0, 0.1);
                margin-bottom: 20px;
            }

            .card-header {
                background-color: #fff;
                border-bottom: 1px solid rgba(0, 0, 0, 0.1);
                font-weight: 600;
                display: flex;
                justify-content: space-between;
                align-items: center;
            }

            .timeline-container {
                position: relative;
                padding: 20px 0;
            }

            .timeline-item {
                position: relative;
                padding-left: 30px;
                margin-bottom: 20px;
            }

            .timeline-icon {
                position: absolute;
                left: 0;
                top: 0;
                width: 24px;
                height: 24px;
                border-radius: 50%;
                display: flex;
                align-items: center;
                justify-content: center;
                color: white;
            }

            .timeline-content {
                background: white;
                padding: 15px;
                border-radius: 8px;
                box-shadow: 0 2px 8px rgba(0, 0, 0, 0.1);
            }

            .timeline-date {
                font-size: 0.85rem;
                color: #6c757d;
            }

            .status-badge {
                padding: 5px 10px;
                border-radius: 20px;
                font-size: 0.8rem;
                font-weight: 600;
            }

            .btn-action {
                margin-right: 8px;
                margin-bottom: 8px;
                min-width: 120px;
            }

            .product-img {
                width: 80px;
                height: 80px;
                object-fit: cover;
                border-radius: 5px;
            }

            .summary-card {
                background-color: #f8f9fa;
                border-radius: 10px;
                padding: 20px;
            }

            .summary-item {
                display: flex;
                justify-content: space-between;
                margin-bottom: 10px;
            }

            .total-amount {
                font-size: 1.2rem;
                font-weight: 600;
                color: #dc3545;
            }

            /* Màu sắc theo trạng thái */
            .status-1 {
                background-color: #28a745;
            }

            /* Đã thanh toán */
            .status-2 {
                background-color: #ffc107;
            }

            /* Chờ xác nhận */
            .status-3 {
                background-color: #17a2b8;
            }

            /* Chờ lấy hàng */
            .status-4 {
                background-color: #6c757d;
            }

            /* Đang giao */
            .status-5 {
                background-color: #28a745;
            }

            /* Đã giao */
            .status-6 {
                background-color: #dc3545;
            }

            /* Đã hủy */
            .status-10 {
                background-color: #6610f2;
            }

            /* Đã thanh toán - chờ xác nhận */
        </style>
        <div class="container-fluid invoice-container">
            <!-- Header và nút hành động -->
            <div class="card mb-4">
                <div class="card-header">
                    <h5 class="mb-0">Chi tiết hóa đơn #<span th:text="${hoaDon.maHoaDon}"></span></h5>
                    <div class="d-flex flex-wrap">
                        <input type="hidden" th:name="idHoaDon" th:value="${hoaDon.id}" />
                        <button type="submit" class="btn btn-danger btn-action" data-bs-toggle="modal"
                            data-bs-target="#modalhuyhoadon"
                            th:unless="${hoaDon.trangThai == 4 or hoaDon.trangThai == 5 or hoaDon.trangThai == 6 or hoaDon.trangThai==11}">
                            <i class="fas fa-times-circle me-1"></i> Hủy đơn
                        </button>
                        <button class="btn btn-success btn-action" id="xacnhan" data-bs-toggle="modal"
                            data-bs-target="#exampleModal"
                            th:unless="${hoaDon.trangThai == 6 or hoaDon.trangThai == 5 or hoaDon.trangThai==11}"
                            onclick="xacNhanHoaDon()">
                            <i class="fas fa-check-circle me-1"></i> Đổi trạng thái
                        </button>
                        <button class="btn btn-outline-danger btn-action" id="quayLaiTrangThaiTruoc"
                            th:value="${hoaDon.id}">
                            <i class="fa-solid fa-rotate-left"></i> Quay lại
                        </button>
                        <button class="btn btn-warning btn-action" id="inhoadon" th:unless="${hoaDon.trangThai != 3}"
                            th:value="${hoaDon.id}" onclick="openInvoicePage(this)">
                            <i class="fas fa-print me-1"></i> In Hóa Đơn
                        </button>
                        <button class="btn btn-info btn-action" id="muaLaiDonHang"
                            th:if="${hoaDon.trangThai == 5 or hoaDon.trangThai == 6 or hoaDon.trangThai == 11}"
                            th:data-id="${hoaDon.id}">
                            <i class="fas fa-redo me-1"></i> Mua lại
                        </button>
                    </div>
                </div>
            </div>

            <!-- Dòng thời gian trạng thái -->
            <div class="card mb-4">
                <div class="card-header">
                    <h5 class="mb-0">Lịch sử trạng thái</h5>
                </div>
                <div class="card-body">
                    <div class="timeline-container">
                        <div th:each="ls, stat : ${lichSuTrangThai}" class="timeline-item">
                            <div class="timeline-icon" th:classappend="'status-' + ${ls.trangThai}">
                                <i th:if="${ls.trangThai == 1}" class="fas fa-check"></i>
                                <i th:if="${ls.trangThai == 2}" class="fas fa-pencil-alt"></i>
                                <i th:if="${ls.trangThai == 3}" class="fas fa-truck"></i>
                                <i th:if="${ls.trangThai == 0}" class="fas fa-times"></i>
                                <i th:if="${ls.trangThai == 4}" class="fas fa-box"></i>
                                <i th:if="${ls.trangThai == 5}" class="fas fa-check-square"></i>
                                <i th:if="${ls.trangThai == 6}" class="fas fa-times-circle"></i>
                                <i th:if="${ls.trangThai == 10}" class="fas fa-venus-double"></i>
                                <i th:if="${ls.trangThai == 11}" class="fas fa-ban" style="color: red;"></i>
                                <i th:if="${ls.trangThai == 12}" class="fas fa-ban" style="color: red;"></i>
                                <i th:if="${ls.trangThai == 13}" class="fas fa-check-square"></i>
                            </div>
                            <div class="timeline-content">
                                <div class="d-flex justify-content-between">
                                    <span class="fw-bold" th:text="${ls.trangThai == 1 ? 'Đã Thanh Toán' :
                                    (ls.trangThai == 2 ? 'Chờ xác nhận' :
                                    (ls.trangThai == 3 ? 'Chờ lấy hàng' :
                                    (ls.trangThai == 0 ? 'Chưa thanh toán' :
                                    (ls.trangThai == 4 ? 'Đang giao' :
                                    (ls.trangThai == 5 ? 'Đã giao' :
                                    (ls.trangThai == 10 ? 'Đã thanh toán - chờ xác nhận':
                                    (ls.trangThai == 11 ? 'Giao thất bại':
                                    (ls.trangThai == 12 ? 'Yêu cầu hủy hàng từ khách hàng':
                                    (ls.trangThai == 13 ? 'Đã nhận hàng thành công!':
                                    'Đã hủy')))))))))}"></span>
                                    <span class="timeline-date"
                                        th:text="${#dates.format(ls.ngayCapNhat,'dd/MM/yyyy HH:mm:ss')}"></span>
                                </div>
                                <div th:if="${ls.ghiChu != null}" class="mt-2">
                                    <small class="text-muted">Ghi chú:</small>
                                    <p class="mb-0" th:text="${ls.ghiChu}"></p>
                                </div>
                            </div>
                        </div>
                    </div>
                </div>
            </div>

            <!-- Thông tin khách hàng và đơn hàng -->
            <div class="row">
                <div class="col-md-6">
                    <div class="card mb-4">
                        <div class="card-header d-flex justify-content-between align-items-center">
                            <h5 class="mb-0">Thông tin khách hàng</h5>
                        </div>
                        <div class="card-body">
                            <div class="mb-3">
                                <label class="text-muted small">Mã hóa đơn</label>
                                <p class="mb-0" th:text="${hoaDon.maHoaDon}"></p>
                            </div>
                            <div class="mb-3">
                                <label class="text-muted small">Tên khách hàng</label>
                                <p class="mb-0" th:text="${hoaDon.tenNguoiNhan}"></p>
                            </div>
                            <div class="mb-3">
                                <label class="text-muted small">Địa chỉ</label>
                                <p class="mb-0"
                                    th:text="${hoaDon.phuongXa + ', ' + hoaDon.quanHuyen + ', ' + hoaDon.tinhThanhPho}">
                                </p>
                            </div>
                            <div class="mb-3">
                                <label class="text-muted small">Số điện thoại</label>
                                <p class="mb-0" th:text="${hoaDon.sdtNguoiNhan}"></p>
                            </div>
                            <div class="mb-3">
                                <label class="text-muted small">Email</label>
                                <p class="mb-0" th:text="${hoaDon.emailNguoiNhan}"></p>
                            </div>
                        </div>
                    </div>
                </div>

                <div class="col-md-6">
                    <div class="card mb-4">
                        <div class="card-header">
                            <h5 class="mb-0">Thông tin vận chuyển</h5>
                            <button th:unless="${ hoaDon.trangThai !=3 && hoaDon.trangThai!=2}"
                                class="btn btn-sm btn-warning" data-bs-toggle="modal" data-bs-target="#capnhatlichsu">
                                <i class="fas fa-edit me-1"></i> Cập nhật
                            </button>
                        </div>

                        <div class="card-body">
                            <div class="mb-3">
                                <label class="text-muted small">Người giao hàng</label>
                                <p class="mb-0" th:text="${hoaDon.tenNguoiGiao ?: 'Chưa cập nhật'}"></p>
                            </div>
                            <div class="mb-3">
                                <label class="text-muted small">Số điện thoại người giao</label>
                                <p class="mb-0" th:text="${hoaDon.sdtNguoiGiao ?: 'Chưa cập nhật'}"></p>
                            </div>
                            <div class="mb-3">
                                <label class="text-muted small">Đơn vị giao hàng</label>
                                <p class="mb-0" th:text="${hoaDon.donViGiaoHang ?: 'Chưa cập nhật'}"></p>
                            </div>
                        </div>
                    </div>
                </div>
            </div>

            <!-- Danh sách sản phẩm -->
            <div class="card mb-4">
                <div class="card-header d-flex justify-content-between align-items-center">
                    <h5 class="mb-0">Danh sách sản phẩm</h5>
                    <button type="button" class="btn btn-primary" data-bs-toggle="modal" data-bs-target="#modalSanPham"
                        th:if="${hoaDon.trangThai==2 or hoaDon.trangThai==3}" th:data-hoadonid="${hoaDon.id}">
                        <i class="fas fa-plus me-1"></i>Thêm sản phẩm
                    </button>
                </div>
                <div class="card-body">
                    <div class="table-responsive">
                        <table class="table table-hover">
                            <thead class="table-light">
                                <tr>
                                    <th>Hình ảnh</th>
                                    <th>Tên sản phẩm</th>
                                    <th>Màu sắc</th>
                                    <th>Size</th>
                                    <th>Đơn giá</th>
                                    <th>Số lượng</th>
                                    <th>Thành tiền</th>
                                    <th>Thao tác</th>
                                </tr>
                            </thead>
                            <tbody>
                                <tr th:each="cthd : ${chiTietHoaDon}">
                                    <td>
                                        <img th:src="${cthd.idChiTietSanPham.hinhAnh!=null?cthd.idChiTietSanPham.hinhAnh.split(',')[0].trim():'/images/defaul-product.png'}"
                                            class="product-img" alt="Sản phẩm">
                                    </td>
                                    <td th:text="${cthd.idChiTietSanPham.idSanPham.tenSanPham}"></td>
                                    <td th:text="${cthd.idChiTietSanPham.idMauSac.tenMauSac}"></td>
                                    <td th:text="${cthd.idChiTietSanPham.idSize.tenSize}"></td>
                                    <td
                                        th:text="${#numbers.formatDecimal(cthd.donGia, 0, 'COMMA', 0, 'POINT')} + ' VNĐ'">
                                    </td>
                                    <td class="text-center">
                                        <input type="number"
                                            class="form-control d-inline-block text-center soLuongInput"
                                            style="width: 70px;" th:value="${cthd.soLuong}" min="1"
                                            th:disabled="${hoaDon == null or (hoaDon.trangThai != 2 and hoaDon.trangThai!=3)}" />
                                    </td>
                                    <td class="text-end"
                                        th:text="${#numbers.formatDecimal(cthd.soLuong*cthd.donGia, 0, 'COMMA', 0, 'POINT')} + ' VNĐ'">
                                    </td>
                                    <td class="text-center">
                                        <button class="btn btn-sm btn-outline-primary btnCapNhatSanPham me-1"
                                            th:data-id-hoa-don="${cthd.idHoaDon.id}"
                                            th:data-id-hoa-don-chi-tiet="${cthd.id}"
                                            th:disabled="${hoaDon == null or (hoaDon.trangThai != 2 and hoaDon.trangThai!=3)}">
                                            <i class="fas fa-sync-alt"></i>
                                        </button>
                                        <button class="btn btn-sm btn-outline-danger btnXoaSanPham"
                                            th:data-id-hoa-don="${cthd.idHoaDon.id}"
                                            th:data-id-hoa-don-chi-tiet="${cthd.id}"
                                            th:disabled="${hoaDon == null or (hoaDon.trangThai != 2 and hoaDon.trangThai!=3)}">
                                            <i class="fas fa-trash-alt"></i>
                                        </button>
                                    </td>
                                </tr>
                            </tbody>
                        </table>
                    </div>
                </div>
            </div>
            <!-- Tổng kết đơn hàng -->
            <div class="row">
                <div class="col-md-6">
                    <div class="card">
                        <div class="card-header">
                            <h5 class="mb-0">Thông tin thanh toán</h5>
                        </div>
                        <div class="card-body">
                            <div class="mb-3">
                                <label class="text-muted small">Phương thức thanh toán</label>
                                <p class="mb-0"
                                    th:text="${hoaDon.loaiThanhToan ? 'Thanh toán bằng VNPay ' : 'Thanh toán khi nhận hàng'}">
                                </p>
                            </div>
                            <div class="payment-status-container mb-4">
                                <label class="payment-status-label">TRẠNG THÁI THANH TOÁN</label>
                                <div class="payment-status-content mt-2">
                                    <!-- Đã thanh toán đủ -->
                                    <div th:if="${hoaDon.loaiThanhToan and hoaDon.tienThua == 0 and (hoaDon.tienKhachDua-hoaDon.thanhTien)>=0}"
                                        class="payment-badge payment-badge-success">
                                        <i class="fas fa-check-circle me-2"></i>
                                        <span>Đã thanh toán: </span>
                                        <span
                                            th:text="${#numbers.formatDecimal(hoaDon.tienKhachDua,0,'COMMA',0,'POINT') + ' VNĐ'}"></span>
                                    </div>
                                    <!-- Đã thanh toán nhưng có tiền thừa -->
                                    <div th:if="${hoaDon.loaiThanhToan and hoaDon.tienThua > 0}"
                                        class="payment-status-group">
                                        <div class="payment-badge payment-badge-success mb-2">
                                            <i class="fas fa-check-circle me-2"></i>
                                            <span>Đã thanh toán: </span>
                                            <span
                                                th:text="${#numbers.formatDecimal(hoaDon.tienKhachDua,0,'COMMA',0,'POINT') + ' VNĐ'}"></span>
                                        </div>
                                        <div class="payment-badge payment-badge-danger">
                                            <i class="fas fa-exchange-alt me-2"></i>
                                            <span>Tiền thừa trả khách: </span>
                                            <span
                                                th:text="${#numbers.formatDecimal(hoaDon.tienThua,0,'COMMA',0,'POINT') + ' VNĐ'}"></span>
                                        </div>
                                    </div>
                                    <!-- Đã thanh toán nhưng có tiền thừa -->
                                    <div th:if="${hoaDon.loaiThanhToan and (hoaDon.thanhTien-hoaDon.tienKhachDua)>0}"
                                        class="payment-status-group">
                                        <div class="payment-badge payment-badge-success mb-2">
                                            <i class="fas fa-check-circle me-2"></i>
                                            <span>Đã thanh toán: </span>
                                            <span
                                                th:text="${#numbers.formatDecimal(hoaDon.tienKhachDua,0,'COMMA',0,'POINT') + ' VNĐ'}"></span>
                                        </div>
                                        <div class="payment-badge payment-badge-danger">
                                            <i class="fas fa-exchange-alt me-2"></i>
                                            <span>Còn phải trả: </span>
                                            <span
                                                th:text=" ' '+${#numbers.formatDecimal((hoaDon.thanhTien-hoaDon.tienKhachDua),0,'COMMA',0,'POINT') + ' VNĐ'}"></span>
                                        </div>
                                    </div>

                                    <!-- Chưa thanh toán -->
                                    <div th:if="${not hoaDon.loaiThanhToan}" class="payment-badge payment-badge-danger">
                                        <i class="fas fa-exclamation-circle me-2"></i>
                                        <span>Còn phải thanh toán: </span>
                                        <span
                                            th:text="' '+ ${#numbers.formatDecimal(hoaDon.thanhTien,0,'COMMA',0,'POINT') + ' VNĐ'}"></span>
                                    </div>
                                </div>
                            </div>
                        </div>
                    </div>
                </div>
                <div class="col-md-6">
                    <div class="card summary-card">
                        <div class="card-header">
                            <h5 class="mb-0">Tổng kết đơn hàng</h5>
                        </div>
                        <div class="card-body">
                            <div class="summary-item">
                                <span>Tổng tiền hàng:</span>
                                <span
                                    th:text="${#numbers.formatDecimal(hoaDon.tongTien, 0, 'COMMA', 0, 'POINT')} + ' VNĐ'"></span>
                            </div>
                            <div class="summary-item">
                                <span>Giảm giá:</span>
                                <span class="text-danger"
                                    th:text="'-' + ${#numbers.formatDecimal(hoaDon.tongTienGiam, 0, 'COMMA', 0, 'POINT')} + ' VNĐ'"></span>
                            </div>
                            <div class="summary-item">
                                <span>Mã giảm giá:</span>
                                <span class="text-danger" th:text="${hoaDon.idKhuyenMai != null} ?
        (hoaDon.idKhuyenMai.loaiKhuyenMai ?
            ${#numbers.formatDecimal(hoaDon.idKhuyenMai.giaTriGiam, 0, 'COMMA', 0, 'POINT')} + ' % cho đơn hàng từ ' +
           ${ #numbers.formatDecimal(hoaDon.idKhuyenMai.dieuKienApDung, 0, 'COMMA', 0, 'POINT')} + ' VNĐ ' :
            ${hoaDon.idKhuyenMai.giaTriGiam} + 'VNĐ cho đơn hàng từ ' +
           ${ #numbers.formatDecimal(hoaDon.idKhuyenMai.dieuKienApDung, 0, 'COMMA', 0, 'POINT')} + ' VNĐ')
        : 'Không có mã khuyến mãi'">
                                </span>
                            </div>
                            <div class="summary-item">
                                <span>Phí vận chuyển:</span>
                                <span id="phiVanChuyen"
                                    th:text="${#numbers.formatDecimal(hoaDon.phiShip, 0, 'COMMA', 0, 'POINT')} + ' VNĐ'"></span>
                            </div>
                            <hr>
                            <div class="summary-item total-amount">
                                <span>Thành tiền:</span>
                                <span
                                    th:text="${#numbers.formatDecimal(hoaDon.thanhTien, 0, 'COMMA', 0, 'POINT')} + ' VNĐ'"></span>
                            </div>
                        </div>
                    </div>
                </div>
            </div>

            <!-- Modal đổi trạng thái -->
            <div class="modal fade" id="exampleModal" tabindex="-1" aria-hidden="true">
                <div class="modal-dialog">
                    <div class="modal-content">
                        <div class="modal-header">
                            <h5 class="modal-title">Đổi trạng thái đơn hàng</h5>
                            <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
                        </div>
                        <div class="modal-body">
                            <form>
                                <div class="mb-3">
                                    <label class="form-label">Ghi chú</label>
                                    <textarea class="form-control" id="note" required></textarea>
                                </div>
                                <div class="mb-3">
                                    <label class="form-label">Trạng thái mới</label>
                                    <select class="form-select" id="status">
                                        <option value="" disabled selected>Chọn trạng thái</option>
                                        <option th:if="${hoaDon.trangThai == 2 || hoaDon.trangThai == 10}" value="3">Xác
                                            nhận đơn</option>
                                        <option th:if="${hoaDon.trangThai == 3}" value="4">Bắt đầu giao hàng</option>
                                        <option th:if="${hoaDon.trangThai == 4}" value="5">Xác nhận đã giao</option>
                                        <option th:if="${hoaDon.trangThai == 4}" value="11">Giao hàng thất bại</option>
                                    </select>
                                </div>
                            </form>
                        </div>
                        <div class="modal-footer">
                            <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Đóng</button>
                            <button type="button" class="btn btn-primary" id="confirmCancel">Xác nhận</button>
                        </div>
                    </div>
                </div>
            </div>

            <!-- Modal hủy đơn -->
            <div class="modal fade" id="modalhuyhoadon" tabindex="-1" aria-hidden="true">
                <div class="modal-dialog">
                    <div class="modal-content">
                        <div class="modal-header">
                            <h5 class="modal-title">Hủy đơn hàng</h5>
                            <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
                        </div>
                        <div class="modal-body">
                            <form>
                                <div class="mb-3">
                                    <label class="form-label">Lý do hủy đơn</label>
                                    <textarea class="form-control" id="notehuyhoadon" required></textarea>
                                </div>
                            </form>
                        </div>
                        <div class="modal-footer">
                            <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Đóng</button>
                            <button type="button" class="btn btn-danger" id="huyhoadon">Xác nhận hủy</button>
                        </div>
                    </div>
                </div>
            </div>

            <!-- Modal thêm sản phẩm -->
            <div class="modal fade" id="modalSanPham" tabindex="-1" aria-labelledby="modalSanPhamLabel"
                aria-hidden="true">
                <div class="modal-dialog modal-xl">
                    <div class="modal-content">
                        <!-- Modal Header -->
                        <div class="modal-header bg-primary text-white">
                            <h5 class="modal-title" id="modalSanPhamLabel">
                                <i class="fas fa-boxes me-2"></i>Danh sách sản phẩm chi tiết
                            </h5>
                            <button type="button" class="btn-close btn-close-white" data-bs-dismiss="modal"
                                aria-label="Close"></button>
                        </div>

                        <!-- Modal Body -->
                        <div class="modal-body">
                            <!-- Bộ lọc sản phẩm -->
                            <form id="filterForm" class="mb-4">
                                <div class="row g-3">
                                    <!-- Tìm kiếm -->
                                    <div class="col-md-3">
                                        <label for="keyword" class="form-label">Tìm kiếm</label>
                                        <div class="input-group">
                                            <span class="input-group-text"><i class="fas fa-search"></i></span>
                                            <input type="text" id="keyword" class="form-control"
                                                placeholder="Tên sản phẩm..." name="keyword" th:value="${keyword}">
                                        </div>
                                    </div>

                                    <!-- Lọc theo danh mục -->
                                    <div class="col-md-3">
                                        <label for="danhMucFilter" class="form-label">Danh mục</label>
                                        <select name="locTheoDanhMuc" class="form-select" id="danhMucFilter">
                                            <option value="">Tất cả danh mục</option>
                                            <option th:each="danhMuc : ${lstDanhMuc}" th:value="${danhMuc.id}"
                                                th:text="${danhMuc.tenDanhMuc}"
                                                th:selected="${locTheoDanhMuc != null and locTheoDanhMuc == danhMuc.id}">
                                            </option>
                                        </select>
                                    </div>

                                    <!-- Lọc theo chất liệu -->
                                    <div class="col-md-3">
                                        <label for="chatLieuFilter" class="form-label">Chất liệu</label>
                                        <select name="locTheoChatLieu" class="form-select" id="chatLieuFilter">
                                            <option value="">Tất cả chất liệu</option>
                                            <option th:each="chatLieu : ${lstChatLieu}" th:value="${chatLieu.id}"
                                                th:text="${chatLieu.tenChatLieu}"
                                                th:selected="${locTheoChatLieu != null and locTheoChatLieu == chatLieu.id}">
                                            </option>
                                        </select>
                                    </div>

                                    <!-- Lọc theo hãng -->
                                    <div class="col-md-3">
                                        <label for="hangFilter" class="form-label">Hãng</label>
                                        <select name="locTheoHang" class="form-select" id="hangFilter">
                                            <option value="">Tất cả hãng</option>
                                            <option th:each="hang : ${lstHang}" th:value="${hang.id}"
                                                th:text="${hang.tenHang}"
                                                th:selected="${locTheoHang != null and locTheoHang == hang.id}">
                                            </option>
                                        </select>
                                    </div>

                                    <!-- Lọc theo màu -->
                                    <div class="col-md-3">
                                        <label for="colorFilter" class="form-label">Màu sắc</label>
                                        <select name="locTheoMauSac" class="form-select" id="colorFilter">
                                            <option value="">Tất cả màu</option>
                                            <option th:each="mauSac : ${lstMauSac}" th:value="${mauSac.id}"
                                                th:text="${mauSac.tenMauSac}"
                                                th:selected="${locTheoMauSac != null and locTheoMauSac == mauSac.id}">
                                            </option>
                                        </select>
                                    </div>

                                    <!-- Lọc theo size -->
                                    <div class="col-md-3">
                                        <label for="sizeFilter" class="form-label">Kích cỡ</label>
                                        <select name="locTheoSize" class="form-select" id="sizeFilter">
                                            <option value="">Tất cả size</option>
                                            <option th:each="size : ${lstSize}" th:value="${size.id}"
                                                th:text="${size.tenSize}"
                                                th:selected="${locTheoSize != null and locTheoSize == size.id}">
                                            </option>
                                        </select>
                                    </div>

                                    <!-- Nút lọc -->
                                    <div class="col-md-3 d-flex align-items-end">
                                        <button type="button" id="applyFilter" class="btn btn-primary me-2 flex-grow-1">
                                            <i class="fas fa-filter me-2"></i>Lọc
                                        </button>
                                        <button type="button" id="clearFilters" class="btn btn-outline-secondary">
                                            <i class="fas fa-times"></i>
                                        </button>
                                    </div>
                                </div>
                            </form>

                            <!-- Bảng sản phẩm -->
                            <div class="table-responsive">
                                <table id="productTable" class="table table-hover table-bordered align-middle">
                                    <thead class="table-light">
                                        <tr>
                                            <th width="120">Hình ảnh</th>
                                            <th>Tên sản phẩm</th>
                                            <th width="150">Giá bán</th>
                                            <th width="120">Số lượng</th>
                                            <th width="120">Thao tác</th>
                                        </tr>
                                    </thead>
                                    <tbody>
                                        <!-- Nội dung sẽ được tải bằng AJAX -->
                                    </tbody>
                                </table>
                            </div>

                            <!-- Phân trang -->
                            <nav aria-label="Page navigation" class="mt-4">
                                <ul class="pagination justify-content-center">
                                    <!-- Nội dung sẽ được tải bằng AJAX -->
                                </ul>
                            </nav>

                        </div>

                        <!-- Modal Footer -->
                        <div class="modal-footer">
                            <button type="button" class="btn btn-outline-secondary" data-bs-dismiss="modal">
                                <i class="fas fa-times me-1"></i>Đóng
                            </button>
                        </div>
                    </div>
                </div>
            </div>

            <!-- Modal cập nhật thông tin -->
            <div class="modal fade" id="capnhatlichsu" tabindex="-1" aria-labelledby="exampleModalLabel"
                aria-hidden="true">
                <!-- Nội dung modal giữ nguyên -->
                <div class="modal-dialog modal-sm" style="max-width: 700px;"> <!-- Sử dụng modal-md để nhỏ hơn -->
                    <div class="modal-content">
                        <div class="modal-header">
                            <h5 class="modal-title fs-5" id="exampleModalLabel">Cập nhật thông tin</h5>
                            <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
                        </div>
                        <div class="modal-body">

                            <!-- Thông tin khách hàng -->
                            <div>
                                <h5>Thông tin khách hàng:</h5>
                                <div class="row row-cols-2">
                                    <div class="col mb-3">
                                        <label for="tenKhachHang" class="form-label">Tên khách hàng <span
                                                class="text-danger">*</span></label>
                                        <input type="text" class="form-control w-80" id="tenKhachHang"
                                            th:field="${hoaDon.tenNguoiNhan}" required />
                                    </div>
                                    <div class="col mb-3">
                                        <label for="sdtKhachHang" class="form-label">Số điện thoại <span
                                                class="text-danger">*</span></label>
                                        <input type="text" class="form-control w-80" id="sdtKhachHang"
                                            th:field="${hoaDon.sdtNguoiNhan}" required />
                                        <div class="invalid-feedback">Số điện thoại không đúng định dạng</div>

                                    </div>
                                    <input type="hidden" id="pickProvince" value="Hà Nội">
                                    <input type="hidden" id="pickDistrict" value="Mỹ Đình">
                                    <input type="hidden" id="pickWard" value="Phú Đô">
                                    <input type="hidden" id="totalWeight" value="1000"> <!-- gram -->

                                    <input type="hidden" id="savedProvince" th:value="${hoaDon.tinhThanhPho}">
                                    <input type="hidden" id="savedDistrict" th:value="${hoaDon.quanHuyen}">
                                    <input type="hidden" id="savedWard" th:value="${hoaDon.phuongXa}">

                                    <div class="col mb-3">
                                        <label for="tinhThanhPho">Tỉnh/Thành phố<span
                                                class="text-danger">*</span></label>
                                        <select class="form-control" id="tinhThanhPho" onchange="loadDistricts()">
                                            <option value="">Chọn tỉnh/thành phố</option>
                                        </select>
                                        <input type="hidden" id="tinhThanhPhoName" name="tinhThanhPho">
                                        <!-- Quan trọng: thêm name -->
                                    </div>

                                    <div class="col mb-3">
                                        <label for="quanHuyen">Quận/Huyện<span class="text-danger">*</span></label>
                                        <select class="form-control" id="quanHuyen" onchange="loadWards()">
                                            <option value="">Chọn quận/huyện</option>
                                        </select>
                                        <input type="hidden" id="quanHuyenName" name="quanHuyen">
                                        <!-- Quan trọng: thêm name -->
                                    </div>
                                </div>
                                <div class="mb-3">
                                    <label for="phuongXa">Phường/Xã<span class="text-danger">*</span></label>
                                    <select class="form-control" id="phuongXa">
                                        <option value="">Chọn phường/xã</option>
                                    </select>
                                    <input type="hidden" id="phuongXaName" name="phuongXa">
                                    <!-- Quan trọng: thêm name -->
                                </div>

                            </div>

                            <!-- Thông tin giao hàng (Hiển thị nếu trạng thái == 3) -->
                            <div>
                                <h5>Thông tin đơn vị giao hàng:</h5>
                                <div class="row row-cols-2">
                                    <div class="col mb-3">
                                        <label for="tenNguoiGiao" class="form-label">Tên người giao<span
                                                class="text-danger">*</span></label>
                                        <input type="text" class="form-control w-80" id="tenNguoiGiao"
                                            th:field="${hoaDon.tenNguoiGiao}" required />
                                    </div>
                                    <div class="col mb-3">
                                        <label for="sdtNguoiGiao" class="form-label">SĐT người giao<span
                                                class="text-danger">*</span></label>
                                        <input type="text" class="form-control w-80" id="sdtNguoiGiao"
                                            th:field="${hoaDon.sdtNguoiGiao}" required />
                                        <div class="invalid-feedback">Số điện thoại không đúng định dạng</div>
                                    </div>
                                    <div class=" col  mb-3">
                                        <label for="donViGiaoHang" class="form-label">Đơn vị giao hàng<span
                                                class="text-danger">*</span></label>
                                        <input type="text" class="form-control w-80" id="donViGiaoHang"
                                            th:field="${hoaDon.donViGiaoHang}" required />
                                    </div>
                                </div>

                            </div>

                        </div>

                        <!-- Nút lưu ở modal-footer để gọn hơn -->
                        <div class="modal-footer">
                            <button type="submit" id="btn-luu-thay-doi" class="btn btn-primary">Lưu thay đổi</button>
                        </div>
                    </div>
                </div>
            </div>
        </div>

        <!-- Các script JavaScript (giữ nguyên từ code gốc) -->

        <!--    Cập nhật số lượng-->
        <script>
            document.addEventListener("DOMContentLoaded", function () {
                document.querySelectorAll(".btnCapNhatSanPham").forEach(button => {
                    button.addEventListener("click", function () {
                        let row = this.closest("tr");
                        let idHoaDon = this.getAttribute("data-id-hoa-don");
                        let idHoaDonChiTiet = this.getAttribute("data-id-hoa-don-chi-tiet");
                        let soLuongMoi = parseInt(row.querySelector(".soLuongInput").value);

                        if (!idHoaDon || !idHoaDonChiTiet) {
                            notyf.error("Lỗi dữ liệu! Vui lòng thử lại.");
                            return;
                        }

                        if (soLuongMoi < 1) {
                            notyf.error("Số lượng phải lớn hơn 0!");
                            row.querySelector(".soLuongInput").value = 1; // Reset lại số lượng nếu nhập sai
                            return;
                        }

                        fetch("/hoadononline/update-sanpham", {
                            method: "POST",
                            headers: {
                                "Content-Type": "application/json"
                            },
                            body: JSON.stringify({
                                idHoaDon: idHoaDon,
                                idHoaDonChiTiet: idHoaDonChiTiet,
                                soLuongMoi: soLuongMoi

                            })
                        })
                            .then(response => response.json())
                            .then(data => {
                                if (data.success) {
                                    notyf.success("Cập nhật thành công!");
                                    tinhPhiShip();
                                    setTimeout(() => {
                                        window.location.reload()
                                    }, 2000)

                                } else {
                                    notyf.error(data.message);
                                    setTimeout(() => {
                                        window.location.reload()
                                    }, 2000)

                                }
                            })
                            .catch(error => {
                                notyf.error("Lỗi hệ thống! Vui lòng thử lại sau.");
                            });
                    });
                });
            });

            function getIdHoaDonFromPath() {
                let pathParts = window.location.pathname.split("/");
                let idHoaDon = pathParts.pop();

                if (!idHoaDon || isNaN(idHoaDon)) {
                    console.error("Không tìm thấy ID hóa đơn!");
                    return null;
                }
                return parseInt(idHoaDon); // Đảm bảo ID là số nguyên
            }


            $(document).ready(function () {
                $('#muaLaiDonHang').click(function () {
                    const idHoaDon = getIdHoaDonFromPath();

                    Swal.fire({
                        title: 'Xác nhận?',
                        text: "Bạn có chắc muốn mua lại đơn hàng này?",
                        icon: 'question',
                        showCancelButton: true,
                        confirmButtonText: 'Mua lại',
                        cancelButtonText: 'Hủy',
                        reverseButtons: true
                    }).then((result) => {
                        if (result.isConfirmed) {
                            fetch("/hoadononline/MuaLai?idHoaDon=" + idHoaDon, {
                                method: "POST"
                            })
                                .then(response => response.json())
                                .then(data => {
                                    if (data.URL) {
                                        notyf.success(data.message);
                                        setTimeout(() => {
                                            window.location.href = "/" + data.URL;
                                        }, 2000);
                                    } else {
                                        notyf.error(data.message);
                                    }
                                })
                                .catch(error => {
                                    notyf.error("Lỗi hệ thống! Vui lòng thử lại sau.");
                                });

                        }
                    });
                });
            });
            document.addEventListener("DOMContentLoaded", function () {
                // Sử dụng event delegation thay vì gắn trực tiếp
                document.addEventListener("click", function (event) {
                    // Kiểm tra nếu phần tử được click có class btnThemVaoHoaDon hoặc nằm trong phần tử có class đó
                    const button = event.target.closest('.btnThemVaoHoaDon');

                    if (button && !button.disabled) {
                        let idChiTietSanPham = parseInt(button.getAttribute("data-id"));
                        let tenSanPham = button.getAttribute("data-ten");
                        let giaBan = parseFloat(button.getAttribute("data-gia"));
                        let hinhAnh = button.getAttribute("data-hinh");
                        let soLuong = 1;
                        let idHoaDon = getIdHoaDonFromPath();

                        if (!idHoaDon) {
                            notyf.error("Không tìm thấy ID hóa đơn trên URL. Vui lòng kiểm tra lại!");
                            return;
                        }

                        fetch("/hoadononline/them-chi-tiet", {
                            method: "POST",
                            headers: { "Content-Type": "application/json" },
                            body: JSON.stringify({
                                idHoaDon: idHoaDon,
                                idChiTietSanPham: idChiTietSanPham,
                                soLuong: soLuong,
                                donGia: giaBan,
                                trangThai: 1
                            })
                        })
                            .then(response => response.json())
                            .then(data => {
                                if (data.success) {
                                    let tbody = document.querySelector("tbody");
                                    let existingRow = tbody.querySelector(`tr[data-id="${idChiTietSanPham}"]`);

                                    if (existingRow) {
                                        notyf.success("Thêm thành công");
                                        tinhPhiShip();
                                        let input = existingRow.querySelector(".soLuongInput");
                                        input.value = parseInt(input.value) + 1;
                                    } else {
                                        tinhPhiShip();
                                        notyf.success("Thêm thành công");
                                        setTimeout(() => {
                                            window.location.reload();
                                        }, 2000);
                                    }
                                } else {
                                    throw new Error(data.message || "Lỗi không xác định!");
                                }
                            })
                            .catch(error => {
                                console.error("Lỗi:", error);
                                notyf.error(error.message);

                            });

                    }
                });
            });

            document.getElementById('huyhoadon').addEventListener('click', async function () {
                try {
                    const idHD = getIdHoaDonFromPath();
                    const note = document.getElementById('notehuyhoadon').value.trim();

                    if (!note) {
                        notyf.error('Vui lòng nhập ghi chú hủy đơn');
                        return;
                    }

                    const result = await Swal.fire({
                        title: 'Xác nhận hủy đơn',
                        text: "Bạn có chắc muốn hủy hóa đơn này?",
                        icon: 'warning',
                        showCancelButton: true,
                        confirmButtonColor: '#d33',
                        cancelButtonColor: '#3085d6',
                        confirmButtonText: 'Xác nhận hủy',
                        cancelButtonText: 'Quay lại'
                    });

                    if (result.isConfirmed) {
                        const response = await $.ajax({
                            type: 'POST',
                            url: '/hoadononline/doi-trang-thai',
                            contentType: 'application/json',
                            data: JSON.stringify({
                                idHoaDon: idHD,
                                ghiChu: note,
                                trangThai: 6
                            })
                        });
                        if (response.success) {
                            notyf.success(response.message || "Hủy đơn thành công");
                            $('#modalhuyhoadon').modal('hide');
                            setTimeout(() => window.location.reload(), 2000);
                            const response2 = await $.ajax({
                                type: 'POST',
                                url: '/hoadononline/guimail',
                                contentType: 'application/json',
                                data: JSON.stringify({
                                    idHoaDon: idHD,
                                    ghiChu: note,
                                    trangThai: 6
                                })
                            });
                            if (response.success) {
                                notyf.success("Đã gửi thông báo tới người dùng")
                            } else {
                                notyf.error("Email bị spam liên tục!!!")
                            }
                        } else {
                            notyf.error("Đổi trạng thái thất bại")
                        }


                    }
                } catch (error) {
                    handleAjaxError(error);
                }
            });



            // Đổi trạng thái
            document.getElementById('confirmCancel').addEventListener('click', async function () {
                try {
                    const idHD = getIdHoaDonFromPath();
                    const note = document.getElementById('note').value.trim();
                    const status = parseInt(document.getElementById('status').value);

                    if (!note) {
                        notyf.error('Vui lòng nhập ghi chú');
                        return;
                    }
                    if (!status) {
                        notyf.error('Vui lòng chọn trạng thái');
                        return;
                    }

                    const result = await Swal.fire({
                        title: 'Xác nhận đổi trạng thái',
                        text: `Bạn có chắc muốn đổi sang trạng thái ${getStateName(status)}?`,
                        icon: 'question',
                        showCancelButton: true,
                        confirmButtonText: 'Xác nhận',
                        cancelButtonText: 'Hủy bỏ'
                    });

                    if (result.isConfirmed) {
                        const response = await $.ajax({
                            type: 'POST',
                            url: '/hoadononline/doi-trang-thai',
                            contentType: 'application/json',
                            data: JSON.stringify({
                                idHoaDon: idHD,
                                ghiChu: note,
                                trangThai: status
                            })
                        });

                        notyf.success(response.message || "Đổi trạng thái thành công");
                        $('#exampleModal').modal('hide');
                        setTimeout(() => window.location.reload(), 1000);
                    }
                } catch (error) {
                    handleAjaxError(error);
                }
            });

            // Helper functions
            function handleAjaxError(error) {
                const errorMsg = error.responseJSON?.message || error.responseText || "Lỗi hệ thống";
                notyf.error(errorMsg);
                console.error("Lỗi:", error);
            }

            function getStateName(state) {
                const states = {
                    0: 'Chưa thanh toán',
                    1: 'Đã thanh toán',
                    2: 'Chờ xác nhận',
                    3: 'Chờ lấy hàng',
                    4: 'Đang giao',
                    5: 'Đã giao',
                    6: 'Đã hủy',
                    10: 'Đã thanh toán - chờ xác nhận',
                    11: 'Giao thất bại'
                };
                return states[state] || `Trạng thái ${state}`;
            }
            document.getElementById("btn-luu-thay-doi").addEventListener("click", function (e) {
                let isValid = true;
                document.querySelectorAll("input[required]").forEach(input => {
                    if (!input.value.trim()) {
                        input.classList.add("is-invalid"); // Hiển thị lỗi
                        isValid = false;
                    } else {
                        input.classList.remove("is-invalid"); // Xóa lỗi nếu đã nhập
                    }
                });

                if (!isValid) {
                    e.preventDefault(); // Ngăn form gửi nếu có lỗi
                    notyf.error("Vui lòng nhập đầy đủ thông tin!");
                    return;
                }
                e.preventDefault(); // Ngăn chặn reload trang
                let sdtNguoiGiao = document.getElementById("sdtNguoiGiao").value.trim();
                let phoneInput = document.getElementById("sdtKhachHang");
                let phoneNumber = phoneInput.value.trim();

                // Biểu thức chính quy kiểm tra số điện thoại Việt Nam hợp lệ
                let phoneRegex = /^(03|05|07|08|09)\d{8}$/;

                if (!phoneRegex.test(phoneNumber)) {
                    phoneInput.classList.add("is-invalid"); // Hiển thị lỗi
                    notyf.error("Số điện thoại không hợp lệ!");
                } else if (!phoneRegex.test(sdtNguoiGiao)) {
                    document.getElementById("sdtNguoiGiao").classList.add("is-invalid");
                    notyf.error("Số điện thoại người giao hàng không hợp lệ!");
                }
                else {
                    // Nếu hợp lệ, có thể gửi AJAX
                    updateHoaDon();
                }

            });
            //cập nhật thông tin khách hàng và thông tin người giao
            function updateHoaDon() {
                var idHD = getIdHoaDonFromPath(); // Hàm lấy ID từ URL hoặc nguồn khác
                let tenNguoiGiao = document.getElementById("tenNguoiGiao").value.trim();
                let sdtNguoiGiao = document.getElementById("sdtNguoiGiao").value.trim();
                let tinhThanhPho = document.getElementById("tinhThanhPhoName").value.trim();
                let quanHuyen = document.getElementById("quanHuyenName").value.trim();
                let phuongXa = document.getElementById("phuongXaName").value.trim();

                let hoaDon = {
                    id: idHD,
                    tenKhachHang: $("#tenKhachHang").val(),
                    sdt: $("#sdtKhachHang").val(),
                    tinhThanhPho: tinhThanhPho,
                    quanHuyen: quanHuyen,
                    phuongXa: phuongXa,
                    tenNguoiGiao: tenNguoiGiao,
                    sdtNguoiGiao: sdtNguoiGiao,
                    donViGiaoHang: donViGiaoHang
                };
                console.log(hoaDon)
                fetch('/hoadononline/updatehoadon', {
                    method: "POST",
                    headers: {
                        "Content-Type": "application/json"
                    },
                    body: JSON.stringify(hoaDon)
                })
                    .then(response => {
                        if (!response.ok) {
                            return response.json().then(data => {
                                throw new Error(data.message || "Có lỗi xảy ra");
                            });
                        }
                        return response.json();
                    })
                    .then(data => {
                        if (data.message) {
                            notyf.success(data.message || "Cập nhật thành công!");
                            $("#capnhatlichsu").modal("hide"); // Ẩn modal
                            setTimeout(() => {
                                location.reload(); // Load lại trang để cập nhật dữ liệu
                            }, 2000);
                        } else {
                            notyf.error("Cập nhật thất bại!");
                            $("#capnhatlichsu").modal("hide"); // Ẩn modal
                        }
                    })
                    .catch(error => {
                        console.error("Lỗi khi cập nhật:", error);
                        notyf.error("Lỗi cập nhật: " + error.message);
                    });
            }
            //xóa sản phẩm
            document.addEventListener("DOMContentLoaded", function () {
                document.querySelectorAll(".btnXoaSanPham").forEach(button => {
                    button.addEventListener("click", function () {
                        let idHoaDon = this.getAttribute("data-id-hoa-don");
                        let idHoaDonChiTiet = this.getAttribute("data-id-hoa-don-chi-tiet");
                        if (!idHoaDon || !idHoaDonChiTiet) {
                            alert("Lỗi: Không lấy được ID sản phẩm hoặc hóa đơn!");
                            return;
                        }

                        if (!confirm("Bạn có chắc muốn xóa sản phẩm này khỏi hóa đơn?")) {
                            return;
                        }

                        fetch(`/hoadononline/xoa-chi-tiet/${idHoaDon}/${idHoaDonChiTiet}`, {
                            method: "DELETE"
                        })
                            .then(response => response.json())
                            .then(data => {
                                if (data.success) {
                                    notyf.success("Xóa thành công")
                                    tinhPhiShip();
                                    this.closest("tr").remove(); // Xóa dòng khỏi bảng
                                    setTimeout(() => {
                                        window.location.reload()
                                    }, 2000)

                                } else {
                                    notyf.error(data.message || "Xóa thất bại")
                                }
                            })
                            .catch(error => {
                                console.error("Lỗi khi xóa:", error);
                                alert("Lỗi hệ thống!");
                            });
                    });
                });
            });
            function openInvoicePage(button) {
                var hoaDonId = button.value; // Lấy ID hóa đơn từ value của nút
                if (hoaDonId) {
                    var url = "/hoadononline/in-hoadon/" + hoaDonId;
                    window.open(url, "_blank"); // Mở trang in hóa đơn trong tab mới
                } else {
                    alert("Không tìm thấy hóa đơn!");
                }
            }


            //xử lí phân trang cho modal them san pham 
            $(document).ready(function () {
                let currentHoaDonId = null;

                // Mở modal và tải dữ liệu ban đầu
                $('#modalSanPham').on('show.bs.modal', function (event) {
                    const button = $(event.relatedTarget);
                    currentHoaDonId = button.data('hoadonid');
                    loadProducts(currentHoaDonId, 0);
                });

                // Xử lý phân trang
                $(document).on('click', '.page-link:not(.disabled)', function (e) {
                    e.preventDefault();
                    const page = $(this).data('page');
                    loadProducts(currentHoaDonId, page);
                });

                // Xử lý submit form filter
                $('#applyFilter').on('click', function (e) {
                    e.preventDefault();
                    loadProducts(currentHoaDonId, 0);
                });

                // Xử lý xóa filter
                $('#clearFilters').on('click', function () {
                    $('#filterForm')[0].reset();
                    loadProducts(currentHoaDonId, 0);
                });

                // Hàm tải sản phẩm bằng AJAX
                function loadProducts(hoaDonId, page) {
                    const formData = $('#filterForm').serialize();

                    $.ajax({
                        url: `/hoadononline/detailhoadononlinect/${hoaDonId}/products?page=${page}&${formData}`,
                        type: 'GET',
                        beforeSend: function () {
                            $('#productTable tbody').html('<tr><td colspan="5" class="text-center"><div class="spinner-border text-primary" role="status"><span class="visually-hidden">Loading...</span></div></td></tr>');
                        },
                        success: function (response) {
                            renderProducts(response.products);
                            renderPagination(response.currentPage, response.totalPages);
                        },
                        error: function (xhr) {
                            console.error(xhr);
                            $('#productTable tbody').html('<tr><td colspan="5" class="text-center text-danger">Đã xảy ra lỗi khi tải dữ liệu</td></tr>');
                        }
                    });
                }

                // Render danh sách sản phẩm
                function renderProducts(products) {
                    let html = '';

                    if (products.length === 0) {
                        html = '<tr><td colspan="5" class="text-center">Không tìm thấy sản phẩm nào</td></tr>';
                    } else {
                        products.forEach(product => {
                            const isOutOfStock = product.soLuong === 0;
                            const imageUrl = product.hinhAnh ? product.hinhAnh.split(',')[0].trim() : '/images/defaul-product.png';

                            html += `
                <tr class="${isOutOfStock ? 'table-danger' : ''}">
                    <td class="text-center">
                        <img src="${imageUrl}" alt="Hình ảnh" class="img-thumbnail" style="width:80px;height:80px;object-fit:cover;">
                    </td>
                    <td>
                        <div class="fw-semibold" style="font-size:1rem; color:#a81423;">${product.idSanPham.tenSanPham}</div>
                        <div class="small text-muted" style="font-size:1rem;">
                            <span class="me-2">màu: ${product.idMauSac.tenMauSac}</span>
                            <span>size: ${product.idSize.tenSize}</span>
                        </div>
                    </td>
                    <td class="text-end fw-bold" style="font-size:1rem;" >
                        ${new Intl.NumberFormat('vi-VN').format(product.giaBan)} VNĐ
                    </td>
                    <td class="text-center">${product.soLuong}</td>
                    <td class="text-center">
                        <button class="btn btn-sm btn-success btnThemVaoHoaDon"
                            data-id="${product.id}"
                            data-ten="${product.idSanPham.tenSanPham}"
                            data-gia="${product.giaBan}"
                            ${isOutOfStock ? 'disabled' : ''}>
                            <i class="fas fa-plus me-1"></i>Thêm
                        </button>
                    </td>
                </tr>
                `;
                        });
                    }

                    $('#productTable tbody').html(html);
                }

                // Render phân trang
                function renderPagination(currentPage, totalPages) {
                    let html = '';

                    // Nút Previous
                    html += `<li class="page-item ${currentPage === 0 ? 'disabled' : ''}">
        <a class="page-link" data-page="${currentPage - 1}">
            <i class="fas fa-angle-left"></i>
        </a>
    </li>`;

                    // Trang đầu + dấu ...
                    if (currentPage > 2) {
                        html += `<li class="page-item">
            <a class="page-link" data-page="0">1</a>
        </li>`;
                        if (currentPage > 3) {
                            html += `<li class="page-item disabled"><span class="page-link">...</span></li>`;
                        }
                    }

                    // Các trang gần currentPage
                    let startPage = Math.max(0, currentPage - 2);
                    let endPage = Math.min(totalPages - 1, currentPage + 2);

                    for (let i = startPage; i <= endPage; i++) {
                        html += `<li class="page-item ${i === currentPage ? 'active' : ''}">
            <a class="page-link" data-page="${i}">${i + 1}</a>
        </li>`;
                    }

                    // Trang cuối + dấu ...
                    if (currentPage < totalPages - 3) {
                        if (currentPage < totalPages - 4) {
                            html += `<li class="page-item disabled"><span class="page-link">...</span></li>`;
                        }
                        html += `<li class="page-item">
            <a class="page-link" data-page="${totalPages - 1}">${totalPages}</a>
        </li>`;
                    }

                    // Nút Next
                    html += `<li class="page-item ${currentPage + 1 === totalPages ? 'disabled' : ''}">
        <a class="page-link" data-page="${currentPage + 1}">
            <i class="fas fa-angle-right"></i>
        </a>
    </li>`;

                    $('.pagination').html(html);
                }

            });
            $(document).ready(function () {

                $('#quayLaiTrangThaiTruoc').click(async function () {
                    var idHoaDon = $(this).val();
                    const result = await Swal.fire({
                        title: 'Xác nhận đổi trạng thái',
                        text: `Bạn có chắc quay lại trạng thái trước `,
                        icon: 'question',
                        showCancelButton: true,
                        confirmButtonText: 'Xác nhận',
                        cancelButtonText: 'Hủy bỏ'
                    });
                    if (result.isConfirmed) {

                        fetch(`/hoadononline/quay-lai-trang-thai-truoc?idHoaDon=` + idHoaDon, {
                            method: 'POST'
                        })
                            .then(response => {
                                if (!response.ok) {
                                    return response.json().then(data => {
                                        notyf.error(data.message || "Quay lại trạng thái cũ thất bại");
                                    });
                                }
                                return response.json();
                            })
                            .then(data => {
                                if (data && data.message) {
                                    notyf.success(data.message || "Đã quay lại trạng thái trước đó");
                                    setTimeout(() => {
                                        location.reload();
                                    }, 2000);
                                }
                            })
                            .catch(error => {
                                console.error("Lỗi khi cập nhật:", error);
                                notyf.error("Lỗi cập nhật: " + error.message);
                            });

                    }
                });
            });


            const API_PROVINCE = "https://provinces.open-api.vn/api/";

            // Load danh sách tỉnh/thành phố
            async function loadProvinces() {
                try {
                    let response = await fetch(API_PROVINCE + "?depth=1");
                    let data = await response.json();

                    let provinceSelect = document.getElementById("tinhThanhPho");
                    provinceSelect.innerHTML = '<option value="">Chọn tỉnh/thành phố</option>';

                    let savedProvince = document.getElementById("savedProvince").value;
                    let foundProvince = false;

                    data.forEach(province => {
                        let option = document.createElement("option");
                        option.value = province.code;
                        option.textContent = province.name;

                        if (province.name === savedProvince) {
                            option.selected = true;
                            foundProvince = true;
                            document.getElementById("tinhThanhPhoName").value = province.name;
                        }

                        provinceSelect.appendChild(option);
                    });

                    if (foundProvince) {
                        await loadDistricts();
                    }
                } catch (error) {
                    console.error("Lỗi khi tải danh sách tỉnh/thành phố:", error);
                }
            }

            // Thêm sự kiện change để cập nhật hidden input
            document.getElementById("tinhThanhPho").addEventListener("change", function () {
                const selectedOption = this.options[this.selectedIndex];
                document.getElementById("tinhThanhPhoName").value = selectedOption.textContent;
                loadDistricts();
            });

            document.getElementById("quanHuyen").addEventListener("change", function () {
                const selectedOption = this.options[this.selectedIndex];
                document.getElementById("quanHuyenName").value = selectedOption.textContent;
                loadWards();
            });

            document.getElementById("phuongXa").addEventListener("change", function () {
                const selectedOption = this.options[this.selectedIndex];
                document.getElementById("phuongXaName").value = selectedOption.textContent;
            });

           // Load danh sách quận/huyện khi chọn tỉnh/thành phố
			async function loadDistricts() {
				let provinceCode = document.getElementById("tinhThanhPho").value;
				if (!provinceCode) return;

				try {
					let response = await fetch(API_PROVINCE + "p/" + provinceCode + "?depth=2");
					let data = await response.json();

					let districtSelect = document.getElementById("quanHuyen");
					districtSelect.innerHTML = '<option value="">Chọn quận/huyện</option>';
					let savedDistrict = document.getElementById("savedDistrict").value;
					data.districts.forEach(district => {
						let option = document.createElement("option");
						option.value = district.code;
						option.textContent = district.name;

						// Chọn quận/huyện đã lưu
						if (district.name === savedDistrict) {
							option.selected = true;

						}

						districtSelect.appendChild(option);
					});

					// Nếu có quận/huyện được chọn thì tự động load phường/xã
					if (districtSelect.value) {
						await loadWards();
						await tinhPhiShip();
					}
				} catch (error) {
					console.error("Lỗi khi tải danh sách quận/huyện:", error);
				}
			}

			// Load danh sách phường/xã khi chọn quận/huyện
			async function loadWards() {
				let districtCode = document.getElementById("quanHuyen").value;
				if (!districtCode) return;

				try {
					let response = await fetch(API_PROVINCE + "d/" + districtCode + "?depth=2");
					let data = await response.json();

					let wardSelect = document.getElementById("phuongXa");
					wardSelect.innerHTML = '<option value="">Chọn phường/xã</option>';

					let savedWard = document.getElementById("savedWard").value;

					data.wards.forEach(ward => {
						let option = document.createElement("option");
						option.value = ward.code;
						option.textContent = ward.name;
						// Chọn phường/xã đã lưu
						if (ward.name === savedWard) {
							option.selected = true;
						}
						wardSelect.appendChild(option);
					});
				} catch (error) {
					console.error("Lỗi khi tải danh sách phường/xã:", error);
				}
			}

            document.addEventListener("DOMContentLoaded", function () {
                loadProvinces();


            });
            document.getElementById("quanHuyen").addEventListener("change", tinhPhiShip);

            //tinh phi vận chuyển
            async function tinhPhiShip() {
                console.log("Đang tính phí ship...");
                const provinceSelect = document.getElementById("tinhThanhPho");
                const districtSelect = document.getElementById("quanHuyen");

                // Kiểm tra đã chọn tỉnh/quận chưa
                if (provinceSelect.selectedIndex <= 0 || districtSelect.selectedIndex <= 0) {
                    notyf.error("Vui lòng chọn đầy đủ tỉnh/thành phố và quận/huyện");
                    return;
                }

                const provinceText = provinceSelect.options[provinceSelect.selectedIndex].text;
                const districtText = districtSelect.options[districtSelect.selectedIndex].text;

                // Lấy thông tin nơi lấy hàng
                const rawPickProvince = document.getElementById("pickProvince").value;
                const rawPickDistrict = document.getElementById("pickDistrict").value;

                // Chuẩn hóa tên
                const pickProvince = normalizeProvinceName(rawPickProvince);
                const pickDistrict = normalizeProvinceName(rawPickDistrict);
                const toProvince = normalizeProvinceName(provinceText);
                const toDistrict = normalizeProvinceName(districtText);

                try {
                    const idHoaDon = getIdHoaDonFromPath(); // Hàm này cần được định nghĩa
                    if (!idHoaDon) {
                        throw new Error("Không tìm thấy ID hóa đơn");
                    }

                    const formData = {
                        pickProvince: pickProvince,
                        pickDistrict: pickDistrict,
                        toProvince: toProvince,
                        toDistrict: toDistrict,
                        idHoaDon: idHoaDon
                    };

                    const response = await fetch('/hoadononline/tinhPhiShip', {
                        method: 'POST',
                        headers: { 'Content-Type': 'application/json' },
                        body: JSON.stringify(formData)
                    });

                    if (!response.ok) {
                        const error = await response.json();
                        throw new Error(error.message || "Tính phí ship thất bại!");
                    }

                    const data = await response.json();
                    const shippingFee = data.fee;

                    document.getElementById("phiVanChuyen").textContent =
                        shippingFee !== undefined ? formatCurrency(shippingFee) + "đ" : "Không tính được";

                } catch (error) {
                    console.error("Lỗi khi tính phí ship:", error);
                    notyf.error(error.message || "Có lỗi xảy ra khi tính phí ship");
                    document.getElementById("phiVanChuyen").textContent = "0";
                }
            }



            function normalizeProvinceName(name) {
                if (!name) return "";
                return name.toLowerCase()
                    .replace(/^(tỉnh|thành phố|quận|huyện)\s*/i, "")
                    .normalize("NFD")
                    .replace(/[\u0300-\u036f]/g, "")
                    .replace(/\s+/g, "");
            }

            function formatCurrency(value) {
                return new Intl.NumberFormat('vi-VN').format(value);
            }
        </script>

    </div>
</body>

</html>