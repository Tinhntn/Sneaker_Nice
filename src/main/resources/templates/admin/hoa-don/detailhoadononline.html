<!DOCTYPE html>
<html lang="vi" xmlns:th="http://www.thymeleaf.org" xmlns:layout="http://www.ultraq.net.nz/thymeleaf/layout"
    layout:decorate="~{layout/main}">

<link href="https://cdn.jsdelivr.net/npm/bootstrap@5.0.2/dist/css/bootstrap.min.css" rel="stylesheet"
    integrity="sha384-EVSTQN3/azprG1Anm3QDgpJLIm9Nao0Yz1ztcQTwFspd3yD65VohhpuuCOmLASjC" crossorigin="anonymous">
<script src="https://cdn.jsdelivr.net/npm/bootstrap@5.0.2/dist/js/bootstrap.bundle.min.js"
    integrity="sha384-MrcW6ZMFYlzcLA8Nl+NtUVF0sA7MsXsP1UyJoMp4YLEuNSfAP+JcXn/tWtIaxVXM"
    crossorigin="anonymous"></script>

<body>
    <div layout:fragment="content">
        <style>
            .nav-tabs {
                border-bottom: 1px solid #dee2e6;
                border-radius: .5rem;
            }

            .nav-tabs .nav-link {
                border: 1px solid transparent;
                border-top-left-radius: .5rem;
                border-top-right-radius: .5rem;
            }

            .nav-tabs .nav-link.active {
                border-color: #dee2e6 #dee2e6 #fff;
            }

            .tab-content {
                border: 1px solid #dee2e6;
                border-top: none;
                border-radius: 0 0 .5rem .5rem;
                padding: 1rem;
            }

            /* Đảm bảo các card có cùng kích thước */


            .card-body {
                display: flex;
                flex-direction: column;
                justify-content: space-between;
            }

            .lich-su-container {
                display: flex;
                align-items: center;
                justify-content: space-around;
                /* You can adjust the spacing as needed */
            }

            .lich-su-item {
                text-align: center;
                padding: 10px;
                position: relative;
                /* This allows the arrow to be positioned absolutely */

            }

            .timeline-icon {
                font-size: 24px;
                margin-bottom: 5px;
            }

            .text-secondary {
                display: block;
                margin-top: 5px;
            }

            .arrow {
                font-size: 24px;
                position: absolute;
                right: -20px;
                /* Adjust this value as needed */
                top: 50%;
                transform: translateY(-50%);
            }

            .modal-dialog {
                max-width: 90%;
                width: 90%;
            }
        </style>
        <div class="card-body row">
            <!-- Nội dung của phần tử này -->
            <div class="lich-su-container">
                <div class="lich-su-item" th:each="ls , stat: ${lichSuTrangThai}">
                    <div class="timeline-icon">
                        <!-- Icon for each status -->
                        <span th:if="${ls.trangThai == 1}" class="fa fa-check"></span>
                        <span th:if="${ls.trangThai == 2}" class="fa fa-pencil"></span>
                        <span th:if="${ls.trangThai == 3}" class="fa fa-truck"></span>
                        <span th:if="${ls.trangThai == 0}" class="fa fa-times"></span>
                        <span th:if="${ls.trangThai == 4}" class="fa fa-box"></span>
                        <span th:if="${ls.trangThai == 5}" class="fa fa-check-square"></span>
                    </div>
                    <span class="text-secondary" th:text="${ls.trangThai == 1 ? 'Đã Thanh Toán' :
                                                                (ls.trangThai == 2 ? 'Chờ xác nhận' :
                                                                (ls.trangThai == 3 ? 'Chờ lấy hàng' :
                                                                (ls.trangThai == 0 ? 'Chưa thanh toán' :
                                                                (ls.trangThai == 4 ? 'Đang giao' :
                                                                (ls.trangThai == 5 ? 'Đã giao' :
                                                                'Đã hủy')))))}"></span>
                    <br>
                    <span th:text="${#dates.format(ls.ngayCapNhat,'dd/MM/yyyy hh:mm:ss')}"></span>
                    <div th:if="${!stat.last}" class="arrow">→</div>

                </div>
            </div>


            <div class="col-4">
                <button type="button" class="btn btn-danger" id="huydon" data-bs-toggle="modal"
                    data-bs-target="#modalhuyhoadon" th:attr="disabled=${hoaDon.trangThai==6}"
                    th:if="${hoaDon.trangThai != 4}">
                    Hủy đơn
                </button>
                <button class="btn btn-success" id="xacnhan" data-bs-toggle="modal" data-bs-target="#exampleModal"
                        th:attr="disabled=${hoaDon.trangThai==6}" th:if="${hoaDon.trangThai!= 4}"
                        onclick="xacNhanHoaDon()">Xác Nhận</button>

                <button class="btn btn-warning" id="inhoadon" th:attr="disabled=${hoaDon.trangThai == 2}">In hóa
                    đơn</button>

                <div class="modal fade" id="exampleModal" tabindex="-1" aria-labelledby="exampleModalLabel"
                    aria-hidden="true">
                    <div class="modal-dialog">
                        <div class="modal-content">
                            <div class="modal-header">
                                <h1 class="modal-title fs-5" id="exampleModalLabel">Ghi chú</h1>
                                <button type="button" class="btn-close" data-bs-dismiss="modal"
                                    aria-label="Close"></button>
                            </div>
                            <div class="modal-body">
                                <form id="cancelForm">
                                    <div class="form-group">
                                        <textarea class="form-control large-textarea" id="note" required></textarea>
                                    </div>
                                    <div class="form-group">
                                        <label for="status">Trạng thái:</label>
                                        <select class="form-control" id="status">
                                            <option value="" disabled selected>Vui lòng chọn trạng thái</option>
                                            <option th:if="${hoaDon.trangThai == 2}" th:value="2">Xác
                                                nhận</option>
                                            <option th:if="${hoaDon.trangThai == 3}" th:value="3">Đã
                                                lấy hàng</option>
                                            <option th:if="${hoaDon.trangThai == 4}" th:value="4">Đã
                                                giao</option>
                                        </select>
                                    </div>
                                </form>
                            </div>
                            <div class="modal-footer">
                                <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Đóng</button>
                                <button type="button" class="btn btn-primary" id="confirmCancel">Thay đổi</button>
                            </div>
                        </div>
                    </div>
                </div>
                <div class="modal fade" id="modalhuyhoadon" tabindex="-1" aria-labelledby="exampleModalLabel"
                    aria-hidden="true">
                    <div class="modal-dialog">
                        <div class="modal-content">
                            <div class="modal-header">
                                <h1 class="modal-title fs-5" id="exampleModalLabel">Ghi chú</h1>
                                <button type="button" class="btn-close" data-bs-dismiss="modal"
                                    aria-label="Close"></button>
                            </div>
                            <div class="modal-body">
                                <form id="cancelForm">
                                    <div class="form-group">
                                        <textarea class="form-control large-textarea" id="notehuyhoadon"
                                            required></textarea>
                                    </div>
                                </form>
                            </div>
                            <div class="modal-footer">
                                <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Đóng</button>
                                <button type="button" class="btn btn-primary" id="huyhoadon">Thay đổi</button>
                            </div>
                        </div>
                    </div>
                </div>
            </div>
        </div>
        <div class="container-fluid">
            <table class="table table-header">
                <thead>
                    <tr>
                        <th>Mã hóa đơn</th>
                        <th>Tên sản phẩm</th>
                        <th>Số lượng</th>
                        <th>Tổng trọng lượng</th>
                        <th>Đơn giá</th>
                        <th>Tổng tiền</th>
                        <th>Ngày tạo</th>
                    </tr>
                </thead>
                <tbody>
                    <tr th:each="cthd : ${chiTietHoaDon}">
                        <td th:text="${cthd.idHoaDon.maHoaDon}"></td>
                        <td th:text="${cthd.idChiTietSanPham.idSanPham.tenSanPham}"></td>
                        <td th:text="${cthd.soLuong}"></td>
                        <td th:text="${cthd.tongTrongLuong}"></td>
                        <td th:text="${#numbers.formatInteger(cthd.donGia,3,'COMMA')+'VNĐ'}"></td>
                        <td th:text="${#numbers.formatInteger(cthd.soLuong*cthd.donGia,3,'COMMA')+'VNĐ'}"></td>
                        <td th:text="${cthd.ngayTao}"></td>

                    </tr>
                </tbody>
            </table>
            <!--        <form id="huy" th:action="@{/hoadononline/huydh/{id}(id=${hdcxn.id})}" method="post">&ndash;&gt;-->
            <!--        <input type="hidden" id="ghichu" name="ghichu" value="">-->
            <!--        <button id="cfhuy" type="button" class="btn btn-outline-secondary">Huỷ</button>-->
            <!--        </form>-->
            <!--        <form id="xacnhan" th:action="@{/hoadononline/xacnhanhoadoncho/{id}(id=${hdcxn.id})}" method="post">-->
            <!--            <input type="hidden" id="" name="ghichu" value="">-->
            <!--            <button id="cfxacnhan" type="button" class="btn btn-outline-secondary">Xác nhận</button>-->
            <!--        </form>-->
        </div>
    
        <div class="container-fluid">
            <div class="card shadow container">
                <h2>Thông tin đơn hàng</h2>
                <div class="card-body">
                    <div class="card-header d-flex justify-content-between align-items-center">
                        <h5 class="card-title mb-0">Thông tin đơn hàng</h5>

                        <button
                            th:attr="disabled=${hoaDon == null or(hoaDon.trangThai != 2 and hoaDon.trangThai !=3) ? 'disabled' : null}"
                            class="btn btn-warning ml-auto" data-bs-toggle="modal" data-bs-target="#capnhatlichsu">Cập
                            nhật</button>
                    </div>
                    <div class="row">
                        <div class="col-md-6">
                            <div class="mb-3">
                                <strong>Mã:</strong>
                                <span th:text="${hoaDon.id}"></span>
                            </div>
                            <div class="mb-3">
                                <strong>Tên khách hàng:</strong>
                                <span th:text="${hoaDon.tenNguoiNhan}"></span>
                            </div>
                            <div class="mb-3">
                                <strong>Địa chỉ:</strong>
                                <span
                                    th:text="${hoaDon.phuongXa + ', ' + hoaDon.quanHuyen + ', ' + hoaDon.tinhThanhPho}"></span>
                            </div>
                            <div class="mb-3">
                                <strong>Số điện thoại người nhận hàng:</strong>
                                <span th:text="${hoaDon.sdtNguoiNhan}"></span>
                            </div>
                            <div class="mb-3">
                                <strong>Email người nhận hàng:</strong>
                                <span th:text="${hoaDon.emailNguoiNhan}"></span>
                            </div>
                        </div>
                        <div class="col-md-6">
                            <div class="mb-3">
                                <strong>Người giao hàng:</strong>
                                <span th:text="${hoaDon.tenNguoiGiao}"></span>
                            </div>
                            <div class="mb-3">
                                <strong>Số điện thoại người giao:</strong>
                                <span th:text="${hoaDon.sdtNguoiGiao}"></span>
                            </div>
                            <div class="mb-3">
                                <strong>Đơn vị giao hàng:</strong>
                                <span th:text="${hoaDon.donViGiaoHang}"></span>
                            </div>
                        </div>
                    </div>

                    <div th:if="${errorMessage}" class="alert alert-danger" role="alert">
                        <p th:text="${errorMessage}"></p>
                    </div>

                </div>
            </div>


        </div>

        <div class="container-fluid">
            <div class="card shadow container">
                <div class="card-header">
                    <button type="button" class="btn btn-primary mb-3" data-bs-toggle="modal"
                        data-bs-target="#modalSanPham"
                        th:attr="disabled=${hoaDon == null or hoaDon.trangThai != 2 ? 'disabled' : null}">
                        Thêm sản phẩm
                    </button>
                </div>
                <div class="card-body">
                    <h1>Danh sách sản phẩm</h1>
                    <table class="table table-header">
                        <thead>
                            <tr>
                                <th>Hình ảnh</th>
                                <th>Tên sản phẩm</th>
                                <th>Đơn giá</th>
                                <th>Số lượng</th> <!-- Sửa lỗi tiêu đề -->
                                <th>Size</th>
                                <th>Thao tác</th>
                            </tr>
                        </thead>
                        <tbody>
                            <tr th:each="chiTietHoaDon : ${chiTietHoaDon}">
                                <td>
                                    <img th:src="${chiTietHoaDon.idChiTietSanPham.hinhAnh}" alt="Image"
                                        style="width:80px;height:50px;" />
                                </td>
                                <td th:text="${chiTietHoaDon.idChiTietSanPham.idSanPham.tenSanPham}"></td>

                                <td
                                    th:text="${#numbers.formatDecimal(chiTietHoaDon.donGia, 0, 'COMMA', 0, 'POINT')} + ' VNĐ'">
                                </td>
                                <td>
                                    <input type="hidden" th:value="${chiTietHoaDon.id}" class="chiTietHoaDonId" />
                                    <input type="hidden" th:value="${chiTietHoaDon.idChiTietSanPham.id}"
                                        class="chiTietSanPhamId" />
                                    <input type="number" class="form-control soLuongInput"
                                        style="width: 80px; display: inline-block;" th:value="${chiTietHoaDon.soLuong}"
                                        min="1"
                                        th:attr="disabled=${hoaDon == null or hoaDon.trangThai != 2 ? 'disabled' : null}" />
                                </td>
                                <td style="text-align: center;">
                                    <span th:text="${chiTietHoaDon.idChiTietSanPham.idSize.tenSize}"></span>
                                </td>
                                <td>
                                    <button class="btn btn-danger btnXoaSanPham"
                                        th:data-id-hoa-don="${chiTietHoaDon.idHoaDon.id}"
                                        th:data-id-san-pham="${chiTietHoaDon.idChiTietSanPham.id}"
                                        th:attr="disabled=${hoaDon == null or hoaDon.trangThai != 2 ? 'disabled' : null}">
                                        Xóa
                                    </button>
                                    <button class="btn btn-primary btnCapNhatSanPham"
                                        th:data-id-hoa-don="${chiTietHoaDon.idHoaDon.id}"
                                        th:data-id-san-pham="${chiTietHoaDon.idChiTietSanPham.id}"
                                        th:attr="disabled=${hoaDon == null or hoaDon.trangThai != 2 ? 'disabled' : null}">
                                        Cập nhật
                                    </button>
                                </td>

                            </tr>
                        </tbody>
                    </table>
                </div>
                <div class="card-footer" style="margin: 10px;">
                    <div class="row">
                        <div class="col-md-6">
                            <div class="mb-3">
                                <strong>Phiếu khuyến mại:</strong>
                                <span th:text="${hoaDon.idKhuyenMai.tenKhuyenMai}"></span>
                            </div>
                            <div class="mb-3">
                                <strong>Tổng tiền hàng:</strong>
                                <span
                                    th:text="${#numbers.formatDecimal(hoaDon.tongTien, 0, 'COMMA', 0, 'POINT')} + ' VNĐ'"></span>
                            </div>
                            <div class="mb-3">
                                <strong>Giảm giá:</strong>
                                <span
                                    th:text="${#numbers.formatDecimal(hoaDon.tongTienGiam, 0, 'COMMA', 0, 'POINT')} + ' VNĐ'"></span>
                            </div>
                        </div>
                        <div class="col-md-6">
                            <div class="mb-3">
                                <strong>Phí vận chuyển:</strong>
                                <span
                                    th:text="${#numbers.formatDecimal(hoaDon.phiShip, 0, 'COMMA', 0, 'POINT')} + ' VNĐ'"></span>
                            </div>
                            <div class="mb-3">
                                <strong>Thành tiền:</strong>
                                <span class="text-danger fw-bold"
                                    th:text="${#numbers.formatDecimal(hoaDon.thanhTien, 0, 'COMMA', 0, 'POINT')} + ' VNĐ'"></span>
                            </div>
                        </div>
                    </div>
                </div>
            </div>



        </div>

        <!--    Cập nhật số lượng-->
        <script>
            document.addEventListener("DOMContentLoaded", function () {
                document.querySelectorAll(".btnCapNhatSanPham").forEach(button => {
                    button.addEventListener("click", function () {
                        let row = this.closest("tr");

                        let idChiTietHoaDon = row.querySelector(".chiTietHoaDonId")?.value || null;
                        let idChiTietSanPham = row.querySelector(".chiTietSanPhamId")?.value || null;
                        let soLuongMoi = parseInt(row.querySelector(".soLuongInput").value);

                        if (!idChiTietHoaDon || !idChiTietSanPham) {
                            notyf.error("Lỗi dữ liệu! Vui lòng thử lại.");
                            return;
                        }

                        if (soLuongMoi < 1) {
                            notyf.error("Số lượng phải lớn hơn 0!");
                            row.querySelector(".soLuongInput").value = 1; // Reset lại số lượng nếu nhập sai
                            return;
                        }

                        fetch("/hoadononline/update-sanpham", {
                            method: "POST",
                            headers: {
                                "Content-Type": "application/json"
                            },
                            body: JSON.stringify({
                                idChiTietHoaDon: idChiTietHoaDon,
                                idChiTietSanPham: idChiTietSanPham,
                                soLuongMoi: soLuongMoi

                            })
                        })
                            .then(response => response.json())
                            .then(data => {
                                if (data.success) {
                                    notyf.success("Cập nhật thành công!");
                                } else {
                                    notyf.error(data.message);
                                }
                            })
                            .catch(error => {
                                notyf.error("Lỗi hệ thống! Vui lòng thử lại sau.");
                            });
                    });
                });
            });
        </script>


        <!-- Modal -->
        <div class="modal fade" id="modalSanPham" tabindex="-1" aria-labelledby="modalSanPhamLabel" aria-hidden="true">
            <div class="modal-dialog modal-lg">
                <div class="modal-content">
                    <div class="modal-header">
                        <h5 class="modal-title" id="modalSanPhamLabel">Danh sách sản phẩm chi tiết</h5>
                        <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
                    </div>
                    <div class="modal-body">
                        <table class="table table-bordered">
                            <thead>
                                <tr>
                                    <th>Hình ảnh</th>
                                    <th>Tên sản phẩm</th>
                                    <th>Giá bán</th>
                                    <th>Số lượng</th>
                                    <th>Thao tác</th>
                                </tr>
                            </thead>
                            <tbody>
                                <tr th:each="sanPhamChiTiet : ${sanPhamChiTiet}">
                                    <td><img th:src="${sanPhamChiTiet.hinhAnh}" alt="Hình ảnh"
                                            style="width:80px;height:50px;"></td>
                                    <td th:text="${sanPhamChiTiet.idSanPham.tenSanPham}"></td>
                                    <td
                                        th:text="${#numbers.formatDecimal(sanPhamChiTiet.giaBan, 0, 'COMMA', 0, 'POINT')} + ' VNĐ'">
                                    </td>
                                    <td th:text="${sanPhamChiTiet.soLuong}"></td>
                                    <td>
                                        <button class="btn btn-success btnThemVaoHoaDon"
                                            th:data-id="${sanPhamChiTiet.id}"
                                            th:data-ten="${sanPhamChiTiet.idSanPham.tenSanPham}"
                                            th:data-gia="${sanPhamChiTiet.giaBan}"
                                            th:data-hinh="${sanPhamChiTiet.hinhAnh}">
                                            Thêm
                                        </button>
                                    </td>
                                </tr>
                            </tbody>
                        </table>
                    </div>
                        <nav aria-label="Page navigation" class="mt-3">
                            <ul class="pagination justify-content-center">
                                <li class="page-item" th:classappend="${currentPageCTSP == 0} ? 'disabled' : ''">
                                    <a th:href="@{/hoaDon/detailhoadononlinect(page=${currentPageCTSP - 1}, size=${10})}"
                                        class="page-link">«</a>
                                </li>
                                <li class="page-item" th:each="i : ${#numbers.sequence(0, totalPagesCTSP - 1)}"
                                    th:classappend="${i == currentPageCTSP} ? 'active' : ''">
                                    <a th:href="@{/hoaDon/detailhoadononlinect(page=${i}, size=${10})}" class="page-link"
                                        th:text="${i + 1}"></a>
                                </li>
                                <li class="page-item" th:classappend="${currentPageCTSP + 1 == totalPagesCTSP} ? 'disabled' : ''">
                                    <a th:href="@{/hoaDon/detailhoadononlinect(page=${currentPageCTSP+1}, size=${10})}" class="page-link">»</a>
                                </li>
                            </ul>
                        </nav>
                </div>
            </div>
        </div>

        <div class="modal fade" id="capnhatlichsu" tabindex="-1" aria-labelledby="exampleModalLabel" aria-hidden="true">
            <div class="modal-dialog modal-sm" style="max-width: 700px;"> <!-- Sử dụng modal-md để nhỏ hơn -->
                <div class="modal-content">
                    <div class="modal-header">
                        <h5 class="modal-title fs-5" id="exampleModalLabel">Cập nhật thông tin</h5>
                        <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
                    </div>
                    <div class="modal-body">

                        <!-- Thông tin khách hàng -->
                        <div th:attr="disabled=${hoaDon.trangThai==2}">
                            <h5>Thông tin khách hàng:</h5>
                            <div class="row row-cols-2">
                                <div class="col mb-3">
                                    <label for="tenKhachHang" class="form-label">Tên khách hàng <span
                                            class="text-danger">*</span></label>
                                    <input type="text" class="form-control w-80" id="tenKhachHang"
                                        th:field="${hoaDon.tenNguoiNhan}" required />
                                </div>
                                <div class="col mb-3">
                                    <label for="sdtKhachHang" class="form-label">Số điện thoại <span
                                            class="text-danger">*</span></label>
                                    <input type="text" class="form-control w-80" id="sdtKhachHang"
                                        th:field="${hoaDon.sdtNguoiNhan}" required />
                                    <div class="invalid-feedback">Số điện thoại không đúng định dạng</div>

                                </div>
                                <div class="col mb-3">
                                    <label for="tinhThanhPho" class="form-label">Tỉnh/Thành phố<span
                                            class="text-danger">*</span></label>
                                    <input type="text" class="form-control w-80" id="tinhThanhPho"
                                        th:field="${hoaDon.tinhThanhPho}" required />
                                </div>
                                <div class="col mb-3">
                                    <label for="quanHuyen" class="form-label">Quận/Huyện<span
                                            class="text-danger">*</span></label>
                                    <input type="text" class="form-control w-80" id="quanHuyen"
                                        th:field="${hoaDon.quanHuyen}" required />
                                </div>

                            </div>
                            <div class="mb-3">
                                <label for="phuongXa" class="form-label">Phường/Xã<span
                                        class="text-danger">*</span></label>
                                <input type="text" class="form-control w-80" id="phuongXa"
                                    th:field="${hoaDon.phuongXa}" required />
                            </div>

                        </div>

                        <!-- Thông tin giao hàng (Hiển thị nếu trạng thái == 3) -->
                        <div th:if="${hoaDon.trangThai==3}">
                            <h5>Thông tin đơn vị giao hàng:</h5>

                            <div class="row row-cols-2">
                                <div class="col mb-3">
                                    <label for="tenNguoiGiao" class="form-label">Tên người giao<span
                                            class="text-danger">*</span></label>
                                    <input type="text" class="form-control w-80" id="tenNguoiGiao"
                                        th:field="${hoaDon.tenNguoiGiao}" required />
                                </div>
                                <div class="col mb-3">
                                    <label for="sdtNguoiGiao" class="form-label">SĐT người giao<span
                                            class="text-danger">*</span></label>
                                    <input type="text" class="form-control w-80" id="sdtNguoiGiao"
                                        th:field="${hoaDon.sdtNguoiGiao}" required />
                                    <div class="invalid-feedback">Số điện thoại không đúng định dạng</div>
                                </div>
                                <div class=" col  mb-3">
                                    <label for="donViGiaoHang" class="form-label">Đơn vị giao hàng<span
                                            class="text-danger">*</span></label>
                                    <input type="text" class="form-control w-80" id="donViGiaoHang"
                                        th:field="${hoaDon.donViGiaoHang}" required />
                                </div>
                            </div>

                        </div>

                    </div>

                    <!-- Nút lưu ở modal-footer để gọn hơn -->
                    <div class="modal-footer">
                        <button type="submit" id="btn-luu-thay-doi" class="btn btn-primary">Lưu thay đổi</button>
                    </div>
                </div>
            </div>
        </div>

        <!--    Thêm sản phẩm vào hóa đơn-->
        <script>
            let notyf = new Notyf({
                duration: 3000,
                position: { x: "right", y: "top" },
            });

            function getIdHoaDonFromPath() {
                let pathParts = window.location.pathname.split("/");
                let idHoaDon = pathParts.pop();

                if (!idHoaDon || isNaN(idHoaDon)) {
                    console.error("Không tìm thấy ID hóa đơn!");
                    return null;
                }
                return parseInt(idHoaDon); // Đảm bảo ID là số nguyên
            }



            document.addEventListener("DOMContentLoaded", function () {
                document.querySelectorAll(".btnThemVaoHoaDon").forEach(button => {
                    button.addEventListener("click", function () {
                        let idChiTietSanPham = parseInt(this.getAttribute("data-id"));
                        let tenSanPham = this.getAttribute("data-ten");
                        let giaBan = parseFloat(this.getAttribute("data-gia"));
                        let hinhAnh = this.getAttribute("data-hinh");

                        let soLuong = 1; // Mặc định là 1
                        let idHoaDon = getIdHoaDonFromPath(); // Lấy ID từ URL

                        if (!idHoaDon) {
                            alert("Không tìm thấy ID hóa đơn trên URL. Vui lòng kiểm tra lại!");
                            return;
                        }

                        fetch("/hoadononline/them-chi-tiet", {
                            method: "POST",
                            headers: { "Content-Type": "application/json" },
                            body: JSON.stringify({
                                idHoaDon: idHoaDon,  // Truyền ID trực tiếp
                                idChiTietSanPham: idChiTietSanPham,
                                soLuong: soLuong,
                                donGia: giaBan,
                                trangThai: 1
                            })
                        })
                            .then(response => response.json()) // Chuyển response thành JSON
                            .then(data => {
                                if (data.success) {
                                    alert("Thêm sản phẩm thành công!");

                                    let tbody = document.querySelector("tbody");
                                    let existingRow = tbody.querySelector(`tr[data-id="${idChiTietSanPham}"]`);

                                    if (existingRow) {
                                        // Nếu sản phẩm đã tồn tại, cập nhật số lượng
                                        let input = existingRow.querySelector(".soLuongInput");
                                        input.value = parseInt(input.value) + 1;
                                    } else {
                                        // Nếu sản phẩm chưa tồn tại, thêm mới
                                        let newRow = `
                                <tr data-id="${idChiTietSanPham}">
                                    <td><img src="${hinhAnh}" alt="Hình ảnh" style="width:80px;height:50px;"></td>
                                    <td>${tenSanPham}</td>
                                    <td>${giaBan.toLocaleString()} VNĐ</td>
                                    <td>
                                        <input type="number" class="form-control soLuongInput" style="width: 80px;" value="1" min="1"/>
                                    </td>
                                    <td>
                                        <button class="btn btn-danger btnXoaSanPham">Xóa</button>
                                    </td>
                                </tr>`;
                                        tbody.insertAdjacentHTML("beforeend", newRow);
                                    }
                                } else {
                                    throw new Error(data.message || "Lỗi không xác định!");
                                }
                            })
                            .catch(error => {
                                console.error("Lỗi:", error);
                                alert("Lỗi: " + error.message);
                            });

                        // Đóng modal sau khi thêm
                        var modal = new bootstrap.Modal(document.getElementById('modalSanPham'));
                        modal.hide();
                    });
                });
            });
            document.getElementById('huyhoadon').addEventListener('click', function () {
                var idHD = getIdHoaDonFromPath();
                var note = document.getElementById('notehuyhoadon').value;
                if (note.trim() === '') {
                    alert('Không được để trống ghi chú');
                    return;
                }
                if (confirm('Bạn có chắc muốn hủy hóa đơn không?')) {
                    let formData = {
                        idhoadon: idHD,
                        ghichu: note,
                        trangthai: 6
                    }
                    $.ajax({
                        type: 'POST',
                        contentType: 'application/json',
                        url: '/hoadononline/doi-trang-thai', // Đường dẫn đến endpoint của controller Spring
                        data: JSON.stringify(formData), // Chuyển đổi đối tượng thành JSON
                        success: function (response) {
                            console.log(response.message)
                            alert(response.message);
                            $('#cancelModal').modal('hide');
                            // Đăng ký sự kiện chỉ 1 lần ngoài Ajax
                            document.getElementById("confirmCancel").addEventListener("click", function () {
                                document.getElementById("note").value = "";
                            });
                            // Chuyển hướng trang
                            window.location.href = '/hoadononline/detailhoadononlinect/' + idHD;
                            // Thực hiện các thao tác khác nếu cần
                        },
                        error: function (error) {
                            if (error.responseJSON && error.responseJSON.message) {
                                alert(error.responseJSON.message);
                            } else if (error.responseText) {
                                alert(error.responseText)
                            } else {
                                alert("Đã xảy ra lỗi, vui lòng thử lại");
                            }; document.getElementById("confirmCancel").addEventListener("click", function () {
                                document.getElementById("note").value = "";
                            });
                            window.location.href = '/hoadononline/detailhoadononlinect/' + idHD;
                            // Đăng ký sự kiện chỉ 1 lần ngoài Ajax
                        }
                    });
                }

            });
            document.getElementById('confirmCancel').addEventListener('click', function () {
                var note = document.getElementById('note').value;
                var status = parseInt(document.getElementById('status').value);
                var idHD = getIdHoaDonFromPath();


                if (note.trim() === '') {
                    alert('Ghi chú không được để trống.');
                    return;
                }
                if (!status) {
                    alert('Vui lòng chọn trạng thái.');
                    return;
                }

                var ttdoi;
                if (status === 2) {
                    ttdoi = 3;
                } else if (status === 3) {
                    ttdoi = 4;
                } else if (status === 4) {
                    ttdoi = 5;
                } else {
                    // Trường hợp mặc định nếu không khớp với bất kỳ giá trị nào
                    alert('Trạng thái không hợp lệ.');
                    return;
                }
                var formData = {
                    idHoaDon: idHD,
                    ghiChu: note,
                    trangThai: ttdoi
                };

                if (confirm('Bạn có muốn đổi trạng thái không ?')) {
                    // Thực hiện AJAX hoặc hành động để thay đổi trạng thái hóa đơn
                    // Ví dụ sử dụng AJAX
                    $.ajax({
                        type: 'POST',
                        contentType: 'application/json',
                        url: '/hoadononline/doi-trang-thai', // Đường dẫn đến endpoint của controller Spring
                        data: JSON.stringify(formData), // Chuyển đổi đối tượng thành JSON
                        success: function (response) {
                            alert(response.message);
                            $('#cancelModal').modal('hide');
                            // Đăng ký sự kiện chỉ 1 lần ngoài Ajax
                            document.getElementById("confirmCancel").addEventListener("click", function () {
                                document.getElementById("note").value = "";
                            });
                            // Chuyển hướng trang
                            window.location.href = '/hoadononline/detailhoadononlinect/' + idHD;
                            // Thực hiện các thao tác khác nếu cần
                        },
                        error: function (xhr) {
                            console.log(xhr);
                            // Kiểm tra xem lỗi có phải là JSON không
                            if (xhr.responseJSON && xhr.responseJSON.message) {
                                alert(xhr.responseJSON.message);
                            } else if (xhr.responseText) {
                                // Trường hợp không phải JSON, lấy responseText
                                alert(xhr.responseText);
                            } else {
                                alert("Đã xảy ra lỗi, vui lòng thử lại.");
                            }
                            document.getElementById("confirmCancel").addEventListener("click", function () {
                                document.getElementById("note").value = "";
                            });
                            window.location.href = '/hoadononline/detailhoadononlinect/' + idHD;
                        }
                    });
                }
            });
            document.getElementById("btn-luu-thay-doi").addEventListener("click", function (e) {
                let isValid = true;

                document.querySelectorAll("input[required]").forEach(input => {
                    if (!input.value.trim()) {
                        input.classList.add("is-invalid"); // Hiển thị lỗi
                        isValid = false;
                    } else {
                        input.classList.remove("is-invalid"); // Xóa lỗi nếu đã nhập
                    }
                });

                if (!isValid) {
                    e.preventDefault(); // Ngăn form gửi nếu có lỗi
                    notyf.error("Vui lòng nhập đầy đủ thông tin!");
                    return;
                }
                e.preventDefault(); // Ngăn chặn reload trang
                let sdtNguoiGiao = document.getElementById("sdtNguoiGiao").value.trim();
                let phoneInput = document.getElementById("sdtKhachHang");
                let phoneNumber = phoneInput.value.trim();

                // Biểu thức chính quy kiểm tra số điện thoại Việt Nam hợp lệ
                let phoneRegex = /^(03|05|07|08|09)\d{8}$/;

                if (!phoneRegex.test(phoneNumber)) {
                    phoneInput.classList.add("is-invalid"); // Hiển thị lỗi
                    notyf.error("Số điện thoại không hợp lệ!");
                } else if (!phoneRegex.test(sdtNguoiGiao)) {
                    document.getElementById("sdtNguoiGiao").classList.add("is-invalid");
                    notyf.error("Số điện thoại người giao hàng không hợp lệ!");
                }
                else {
                    // Nếu hợp lệ, có thể gửi AJAX
                    updateHoaDon();
                }

            });
            function updateHoaDon() {
                var idHD = getIdHoaDonFromPath(); // Hàm lấy ID từ URL hoặc nguồn khác
                let tenNguoiGiao = document.getElementById("tenNguoiGiao").value.trim();
                let sdtNguoiGiao = document.getElementById("sdtNguoiGiao").value.trim();
                let donViGiaoHang = document.getElementById("donViGiaoHang").value.trim();
                if (tenNguoiGiao == '' || sdtNguoiGiao == '' || donViGiaoHang == '') {
                    tenNguoiGiao = 'Không có';
                    sdtNguoiGiao = 'Không có';
                    donViGiaoHang = 'Không có';

                }
                let hoaDon = {
                    id: idHD,
                    tenKhachHang: $("#tenKhachHang").val(),
                    sdt: $("#sdtKhachHang").val(),
                    tinhThanhPho: $("#tinhThanhPho").val(),
                    quanHuyen: $("#quanHuyen").val(),
                    phuongXa: $("#phuongXa").val(),
                    tenNguoiGiao: tenNguoiGiao,
                    sdtNguoiGiao: sdtNguoiGiao,
                    donViGiaoHang: donViGiaoHang
                };

                fetch('/hoadononline/updatehoadon', {
                    method: "POST",
                    headers: {
                        "Content-Type": "application/json"
                    },
                    body: JSON.stringify(hoaDon)
                })
                    .then(response => {
                        if (!response.ok) {
                            return response.json().then(data => {
                                throw new Error(data.message || "Có lỗi xảy ra");
                            });
                        }
                        return response.json();
                    })
                    .then(data => {
                        if (data.message) {
                            notyf.success(data.message || "Cập nhật thành công!");
                            $("#capnhatlichsu").modal("hide"); // Ẩn modal
                            setTimeout(() => {
                                location.reload(); // Load lại trang để cập nhật dữ liệu
                            }, 2000);
                        } else {
                            notyf.error("Cập nhật thất bại!");
                            $("#capnhatlichsu").modal("hide"); // Ẩn modal
                        }
                    })
                    .catch(error => {
                        console.error("Lỗi khi cập nhật:", error);
                        notyf.error("Lỗi cập nhật: " + error.message);
                    });
            }
            document.addEventListener("DOMContentLoaded", function () {
                document.querySelectorAll(".btnXoaSanPham").forEach(button => {
                    button.addEventListener("click", function () {
                        let idHoaDon = this.getAttribute("data-id-hoa-don");
                        let idChiTietSanPham = this.getAttribute("data-id-san-pham");

                        if (!idHoaDon || !idChiTietSanPham) {
                            alert("Lỗi: Không lấy được ID sản phẩm hoặc hóa đơn!");
                            return;
                        }

                        if (!confirm("Bạn có chắc muốn xóa sản phẩm này khỏi hóa đơn?")) {
                            return;
                        }

                        fetch(`/hoadononline/xoa-chi-tiet/${idHoaDon}/${idChiTietSanPham}`, {
                            method: "DELETE"
                        })
                            .then(response => response.json())
                            .then(data => {
                                if (data.success) {
                                    alert("Xóa thành công!");
                                    this.closest("tr").remove(); // Xóa dòng khỏi bảng
                                } else {
                                    alert("Lỗi: " + data.message);
                                }
                            })
                            .catch(error => {
                                console.error("Lỗi khi xóa:", error);
                                alert("Lỗi hệ thống!");
                            });
                    });
                });
            });

        </script>


<!--        Xác nhận hóa đơn chi tiết-->
        <script th:inline="javascript">
            function xacNhanHoaDon() {
                let hoaDonId = [[${hoaDon.id}]]; // Lấy ID hóa đơn từ Thymeleaf

                fetch('/hoadononline/xacnhan/' + hoaDonId, {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                })
                    .then(response => response.json())
                    .then(data => {
                        if (!data.success) {
                            alert('Lỗi: ' + data.message);
                        }
                    })
                    .catch(error => console.error('Lỗi:', error));
            }
        </script>




    </div>
</body>

</html>