<!DOCTYPE html>
<html lang="vi" xmlns:th="http://www.thymeleaf.org" xmlns:layout="http://www.ultraq.net.nz/thymeleaf/layout"
    layout:decorate="~{layout/main}">

<link href="https://cdn.jsdelivr.net/npm/bootstrap@5.0.2/dist/css/bootstrap.min.css" rel="stylesheet"
    integrity="sha384-EVSTQN3/azprG1Anm3QDgpJLIm9Nao0Yz1ztcQTwFspd3yD65VohhpuuCOmLASjC" crossorigin="anonymous">
<script src="https://cdn.jsdelivr.net/npm/bootstrap@5.0.2/dist/js/bootstrap.bundle.min.js"
    integrity="sha384-MrcW6ZMFYlzcLA8Nl+NtUVF0sA7MsXsP1UyJoMp4YLEuNSfAP+JcXn/tWtIaxVXM"
    crossorigin="anonymous"></script>

<body>
    <div layout:fragment="content">
        <style>
            .nav-tabs {
                border-bottom: 1px solid #dee2e6;
                border-radius: .5rem;
            }

            .nav-tabs .nav-link {
                border: 1px solid transparent;
                border-top-left-radius: .5rem;
                border-top-right-radius: .5rem;
            }

            .nav-tabs .nav-link.active {
                border-color: #dee2e6 #dee2e6 #fff;
            }

            .tab-content {
                border: 1px solid #dee2e6;
                border-top: none;
                border-radius: 0 0 .5rem .5rem;
                padding: 1rem;
            }

            /* ƒê·∫£m b·∫£o c√°c card c√≥ c√πng k√≠ch th∆∞·ªõc */


            .card-body {
                display: flex;
                flex-direction: column;
                justify-content: space-between;
            }

            .lich-su-container {
                display: flex;
                align-items: center;
                justify-content: space-around;
                /* You can adjust the spacing as needed */
            }

            .lich-su-item {
                text-align: center;
                padding: 10px;
                position: relative;
                /* This allows the arrow to be positioned absolutely */

            }

            .timeline-icon {
                font-size: 24px;
                margin-bottom: 5px;
            }

            .text-secondary {
                display: block;
                margin-top: 5px;
            }

            .arrow {
                font-size: 24px;
                position: absolute;
                right: -20px;
                /* Adjust this value as needed */
                top: 50%;
                transform: translateY(-50%);
            }

            .modal-dialog {
                max-width: 90%;
                width: 90%;
            }
        </style>
        <div class="card-body row">
            <!-- N·ªôi dung c·ªßa ph·∫ßn t·ª≠ n√†y -->
            <div class="lich-su-container">
                <div class="lich-su-item" th:each="ls , stat: ${lichSuTrangThai}">
                    <div class="timeline-icon">
                        <!-- Icon for each status -->
                        <span th:if="${ls.trangThai == 1}" class="fa fa-check"></span>
                        <span th:if="${ls.trangThai == 2}" class="fa fa-pencil"></span>
                        <span th:if="${ls.trangThai == 3}" class="fa fa-truck"></span>
                        <span th:if="${ls.trangThai == 0}" class="fa fa-times"></span>
                        <span th:if="${ls.trangThai == 4}" class="fa fa-box"></span>
                        <span th:if="${ls.trangThai == 5}" class="fa fa-check-square"></span>
                        <span th:if="${ls.trangThai == 6}" class="fa fa-times-circle"></span>
                        <span th:if="${ls.trangThai == 10}" class="fa fa-venus-double"></span>

                    </div>
                    <span class="text-secondary" th:text="${ls.trangThai == 1 ? 'ƒê√£ Thanh To√°n' :
                                                                (ls.trangThai == 2 ? 'Ch·ªù x√°c nh·∫≠n' :
                                                                (ls.trangThai == 3 ? 'Ch·ªù l·∫•y h√†ng' :
                                                                (ls.trangThai == 0 ? 'Ch∆∞a thanh to√°n' :
                                                                (ls.trangThai == 4 ? 'ƒêang giao' :
                                                                (ls.trangThai == 5 ? 'ƒê√£ giao' :
                                                                (ls.trangThai == 10 ? 'ƒê√£ thanh to√°n - ch·ªù x√°c nh·∫≠n':
                                                                'ƒê√£ h·ªßy'))))))}"></span>
                    <br>
                    <span th:text="${#dates.format(ls.ngayCapNhat,'dd/MM/yyyy hh:mm:ss')}"></span>
                    <div th:if="${!stat.last}" class="arrow">‚Üí</div>

                </div>
            </div>


            <div class="col-4">
                <button type="button" class="btn btn-danger" id="huydon" data-bs-toggle="modal"
                    data-bs-target="#modalhuyhoadon" th:attr="disabled=${hoaDon.trangThai==6}"
                    th:if="${hoaDon.trangThai != 4}">
                    H·ªßy ƒë∆°n
                </button>
                <button class="btn btn-success" id="xacnhan" data-bs-toggle="modal" data-bs-target="#exampleModal"
                        th:attr="disabled=${hoaDon.trangThai==6}" th:if="${hoaDon.trangThai!= 4}"
                        onclick="xacNhanHoaDon()">X√°c Nh·∫≠n</button>

                <button class="btn btn-warning" id="inhoadon"
                        th:attr="disabled=${hoaDon.trangThai == 2}"
                        th:value="${hoaDon.id}"
                        onclick="openInvoicePage(this)">
                    üñ®Ô∏è In H√≥a ƒê∆°n
                </button>


                <div class="modal fade" id="exampleModal" tabindex="-1" aria-labelledby="exampleModalLabel"
                    aria-hidden="true">
                    <div class="modal-dialog">
                        <div class="modal-content">
                            <div class="modal-header">
                                <h1 class="modal-title fs-5" id="exampleModalLabel">Ghi ch√∫</h1>
                                <button type="button" class="btn-close" data-bs-dismiss="modal"
                                    aria-label="Close"></button>
                            </div>
                            <div class="modal-body">
                                <form id="cancelForm">
                                    <div class="form-group">
                                        <textarea class="form-control large-textarea" id="note" required></textarea>
                                    </div>
                                    <div class="form-group">
                                        <label for="status">Tr·∫°ng th√°i:</label>
                                        <select class="form-control" id="status">
                                            <option value="" disabled selected>Vui l√≤ng ch·ªçn tr·∫°ng th√°i</option>
                                            <option th:if="${hoaDon.trangThai == 2||hoaDon.trangThai==10}" th:value="2">X√°c
                                                nh·∫≠n</option>
                                            <option th:if="${hoaDon.trangThai == 3}" th:value="3">ƒê√£
                                                l·∫•y h√†ng</option>
                                            <option th:if="${hoaDon.trangThai == 4}" th:value="4">ƒê√£
                                                giao</option>
                                        </select>
                                    </div>
                                </form>
                            </div>
                            <div class="modal-footer">
                                <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">ƒê√≥ng</button>
                                <button type="button" class="btn btn-primary" id="confirmCancel">Thay ƒë·ªïi</button>
                            </div>
                        </div>
                    </div>
                </div>
                <div class="modal fade" id="modalhuyhoadon" tabindex="-1" aria-labelledby="exampleModalLabel"
                    aria-hidden="true">
                    <div class="modal-dialog">
                        <div class="modal-content">
                            <div class="modal-header">
                                <h1 class="modal-title fs-5" id="exampleModalLabel">Ghi ch√∫</h1>
                                <button type="button" class="btn-close" data-bs-dismiss="modal"
                                    aria-label="Close"></button>
                            </div>
                            <div class="modal-body">
                                <form id="cancelForm">
                                    <div class="form-group">
                                        <textarea class="form-control large-textarea" id="notehuyhoadon"
                                            required></textarea>
                                    </div>
                                </form>
                            </div>
                            <div class="modal-footer">
                                <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">ƒê√≥ng</button>
                                <button type="button" class="btn btn-primary" id="huyhoadon">Thay ƒë·ªïi</button>
                            </div>
                        </div>
                    </div>
                </div>
            </div>
        </div>
        <div class="container-fluid">
            <table class="table table-header">
                <thead>
                    <tr>
                        <th>M√£ h√≥a ƒë∆°n</th>
                        <th>T√™n s·∫£n ph·∫©m</th>
                        <th>S·ªë l∆∞·ª£ng</th>
                        <th>T·ªïng tr·ªçng l∆∞·ª£ng</th>
                        <th>ƒê∆°n gi√°</th>
                        <th>T·ªïng ti·ªÅn</th>
                        <th>Ng√†y t·∫°o</th>
                    </tr>
                </thead>
                <tbody>
                    <tr th:each="cthd : ${chiTietHoaDon}">
                        <td th:text="${cthd.idHoaDon.maHoaDon}"></td>
                        <td th:text="${cthd.idChiTietSanPham.idSanPham.tenSanPham}"></td>
                        <td th:text="${cthd.soLuong}"></td>
                        <td th:text="${cthd.tongTrongLuong}"></td>
                        <td th:text="${#numbers.formatInteger(cthd.donGia,3,'COMMA')+'VNƒê'}"></td>
                        <td th:text="${#numbers.formatInteger(cthd.soLuong*cthd.donGia,3,'COMMA')+'VNƒê'}"></td>
                        <td th:text="${cthd.ngayTao}"></td>

                    </tr>
                </tbody>
            </table>
            <!--        <form id="huy" th:action="@{/hoadononline/huydh/{id}(id=${hdcxn.id})}" method="post">&ndash;&gt;-->
            <!--        <input type="hidden" id="ghichu" name="ghichu" value="">-->
            <!--        <button id="cfhuy" type="button" class="btn btn-outline-secondary">Hu·ª∑</button>-->
            <!--        </form>-->
            <!--        <form id="xacnhan" th:action="@{/hoadononline/xacnhanhoadoncho/{id}(id=${hdcxn.id})}" method="post">-->
            <!--            <input type="hidden" id="" name="ghichu" value="">-->
            <!--            <button id="cfxacnhan" type="button" class="btn btn-outline-secondary">X√°c nh·∫≠n</button>-->
            <!--        </form>-->
        </div>

        <div class="container-fluid">
            <div class="card shadow container">
                <h2>Th√¥ng tin ƒë∆°n h√†ng</h2>
                <div class="card-body">
                    <div class="card-header d-flex justify-content-between align-items-center">
                        <h5 class="card-title mb-0">Th√¥ng tin ƒë∆°n h√†ng</h5>

                        <button
                            th:attr="disabled=${hoaDon.trangThai == null or(hoaDon.trangThai != 2 and hoaDon.trangThai!=3) ? 'disabled' : null}"
                            class="btn btn-warning ml-auto" data-bs-toggle="modal" data-bs-target="#capnhatlichsu">C·∫≠p
                            nh·∫≠t</button>
                    </div>
                    <div class="row">
                        <div class="col-md-6">
                            <div class="mb-3">
                                <strong>M√£:</strong>
                                <span th:text="${hoaDon.id}"></span>
                            </div>
                            <div class="mb-3">
                                <strong>T√™n kh√°ch h√†ng:</strong>
                                <span th:text="${hoaDon.tenNguoiNhan}"></span>
                            </div>
                            <div class="mb-3">
                                <strong>ƒê·ªãa ch·ªâ:</strong>
                                <span
                                    th:text="${hoaDon.phuongXa + ', ' + hoaDon.quanHuyen + ', ' + hoaDon.tinhThanhPho}"></span>
                            </div>
                            <div class="mb-3">
                                <strong>S·ªë ƒëi·ªán tho·∫°i ng∆∞·ªùi nh·∫≠n h√†ng:</strong>
                                <span th:text="${hoaDon.sdtNguoiNhan}"></span>
                            </div>
                            <div class="mb-3">
                                <strong>Email ng∆∞·ªùi nh·∫≠n h√†ng:</strong>
                                <span th:text="${hoaDon.emailNguoiNhan}"></span>
                            </div>
                        </div>
                        <div class="col-md-6">
                            <div class="mb-3">
                                <strong>Ng∆∞·ªùi giao h√†ng:</strong>
                                <span th:text="${hoaDon.tenNguoiGiao}"></span>
                            </div>
                            <div class="mb-3">
                                <strong>S·ªë ƒëi·ªán tho·∫°i ng∆∞·ªùi giao:</strong>
                                <span th:text="${hoaDon.sdtNguoiGiao}"></span>
                            </div>
                            <div class="mb-3">
                                <strong>ƒê∆°n v·ªã giao h√†ng:</strong>
                                <span th:text="${hoaDon.donViGiaoHang}"></span>
                            </div>
                        </div>
                    </div>

                    <div th:if="${errorMessage}" class="alert alert-danger" role="alert">
                        <p th:text="${errorMessage}"></p>
                    </div>

                </div>
            </div>


        </div>

        <div class="container-fluid">
            <div class="card shadow container">
                <div class="card-header">
                    <button type="button" class="btn btn-primary mb-3" data-bs-toggle="modal"
                        data-bs-target="#modalSanPham"
                        th:attr="disabled=${hoaDon == null or(hoaDon.trangThai != 2 and hoaDon.trangThai!=3)? 'disabled' : null}">
                        Th√™m s·∫£n ph·∫©m
                    </button>
                </div>
                <div class="card-body">
                    <h1>Danh s√°ch s·∫£n ph·∫©m</h1>
                    <table class="table table-header">
                        <thead>
                            <tr>
                                <th>H√¨nh ·∫£nh</th>
                                <th>T√™n s·∫£n ph·∫©m</th>
                                <th>ƒê∆°n gi√°</th>
                                <th>S·ªë l∆∞·ª£ng</th> <!-- S·ª≠a l·ªói ti√™u ƒë·ªÅ -->
                                <th>Size</th>
                                <th>Thao t√°c</th>
                            </tr>
                        </thead>
                        <tbody>
                            <tr th:each="chiTietHoaDon : ${chiTietHoaDon}">
                                <td>
                                    <img th:src="${chiTietHoaDon.idChiTietSanPham.hinhAnh}" alt="Image"
                                        style="width:80px;height:50px;" />
                                </td>
                                <td th:text="${chiTietHoaDon.idChiTietSanPham.idSanPham.tenSanPham}"></td>

                                <td
                                    th:text="${#numbers.formatDecimal(chiTietHoaDon.donGia, 0, 'COMMA', 0, 'POINT')} + ' VNƒê'">
                                </td>
                                <td>
                                    <input type="hidden" th:value="${chiTietHoaDon.id}" class="chiTietHoaDonId" />
                                    <input type="hidden" th:value="${chiTietHoaDon.idChiTietSanPham.id}"
                                        class="chiTietSanPhamId" />
                                    <input type="number" class="form-control soLuongInput"
                                        style="width: 80px; display: inline-block;" th:value="${chiTietHoaDon.soLuong}"
                                        min="1"
                                        th:attr="disabled=${hoaDon == null or (hoaDon.trangThai != 2 and hoaDon.trangThai!=3) ? 'disabled' : null}" />
                                </td>
                                <td style="text-align: center;">
                                    <span th:text="${chiTietHoaDon.idChiTietSanPham.idSize.tenSize}"></span>
                                </td>
                                <td>
                                    <button class="btn btn-danger btnXoaSanPham"
                                        th:data-id-hoa-don="${chiTietHoaDon.idHoaDon.id}"
                                        th:data-id-san-pham="${chiTietHoaDon.idChiTietSanPham.id}"
                                        th:attr="disabled=${hoaDon == null or (hoaDon.trangThai != 2 and hoaDon.trangThai!=3)? 'disabled' : null}">
                                        X√≥a
                                    </button>
                                    <button class="btn btn-primary btnCapNhatSanPham"
                                        th:data-id-hoa-don="${chiTietHoaDon.idHoaDon.id}"
                                        th:data-id-san-pham="${chiTietHoaDon.idChiTietSanPham.id}"
                                        th:attr="disabled=${hoaDon == null or (hoaDon.trangThai != 2 and hoaDon.trangThai!=3) ? 'disabled' : null}">
                                        C·∫≠p nh·∫≠t
                                    </button>
                                </td>

                            </tr>
                        </tbody>
                    </table>
                </div>
                <div class="card-footer" style="margin: 10px;">
                    <div class="row">
                        <div class="col-md-6">
                            <div class="mb-3">
                                <strong>Phi·∫øu khuy·∫øn m·∫°i:</strong>
                                <span th:text="${hoaDon.idKhuyenMai.tenKhuyenMai}"></span>
                            </div>
                            <div class="mb-3">
                                <strong>T·ªïng ti·ªÅn h√†ng:</strong>
                                <span
                                    th:text="${#numbers.formatDecimal(hoaDon.tongTien, 0, 'COMMA', 0, 'POINT')} + ' VNƒê'"></span>
                            </div>
                            <div class="mb-3">
                                <strong>Gi·∫£m gi√°:</strong>
                                <span
                                    th:text="${#numbers.formatDecimal(hoaDon.tongTienGiam, 0, 'COMMA', 0, 'POINT')} + ' VNƒê'"></span>
                            </div>
                        </div>
                        <div class="col-md-6">
                            <div class="mb-3">
                                <strong>Ph√≠ v·∫≠n chuy·ªÉn:</strong>
                                <span
                                    th:text="${#numbers.formatDecimal(hoaDon.phiShip, 0, 'COMMA', 0, 'POINT')} + ' VNƒê'"></span>
                            </div>
                            <div class="mb-3">
                                <strong>Th√†nh ti·ªÅn:</strong>
                                <span class="text-danger fw-bold"
                                    th:text="${#numbers.formatDecimal(hoaDon.thanhTien, 0, 'COMMA', 0, 'POINT')} + ' VNƒê'"></span>
                            </div>
                        </div>
                    </div>
                </div>
            </div>



        </div>

        <!--    C·∫≠p nh·∫≠t s·ªë l∆∞·ª£ng-->
        <script>
            document.addEventListener("DOMContentLoaded", function () {
                document.querySelectorAll(".btnCapNhatSanPham").forEach(button => {
                    button.addEventListener("click", function () {
                        let row = this.closest("tr");

                        let idChiTietHoaDon = row.querySelector(".chiTietHoaDonId")?.value || null;
                        let idChiTietSanPham = row.querySelector(".chiTietSanPhamId")?.value || null;
                        let soLuongMoi = parseInt(row.querySelector(".soLuongInput").value);

                        if (!idChiTietHoaDon || !idChiTietSanPham) {
                            notyf.error("L·ªói d·ªØ li·ªáu! Vui l√≤ng th·ª≠ l·∫°i.");
                            return;
                        }

                        if (soLuongMoi < 1) {
                            notyf.error("S·ªë l∆∞·ª£ng ph·∫£i l·ªõn h∆°n 0!");
                            row.querySelector(".soLuongInput").value = 1; // Reset l·∫°i s·ªë l∆∞·ª£ng n·∫øu nh·∫≠p sai
                            return;
                        }

                        fetch("/hoadononline/update-sanpham", {
                            method: "POST",
                            headers: {
                                "Content-Type": "application/json"
                            },
                            body: JSON.stringify({
                                idChiTietHoaDon: idChiTietHoaDon,
                                idChiTietSanPham: idChiTietSanPham,
                                soLuongMoi: soLuongMoi

                            })
                        })
                            .then(response => response.json())
                            .then(data => {
                                if (data.success) {
                                    notyf.success("C·∫≠p nh·∫≠t th√†nh c√¥ng!");
                                } else {
                                    notyf.error(data.message);
                                }
                            })
                            .catch(error => {
                                notyf.error("L·ªói h·ªá th·ªëng! Vui l√≤ng th·ª≠ l·∫°i sau.");
                            });
                    });
                });
            });
        </script>


        <!-- Modal -->
        <div class="modal fade" id="modalSanPham" tabindex="-1" aria-labelledby="modalSanPhamLabel" aria-hidden="true">
            <div class="modal-dialog modal-lg">
                <div class="modal-content">
                    <div class="modal-header">
                        <h5 class="modal-title" id="modalSanPhamLabel">Danh s√°ch s·∫£n ph·∫©m chi ti·∫øt</h5>
                        <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
                    </div>
                    <div class="modal-body">
                        <table class="table table-bordered">
                            <thead>
                                <tr>
                                    <th>H√¨nh ·∫£nh</th>
                                    <th>T√™n s·∫£n ph·∫©m</th>
                                    <th>Gi√° b√°n</th>
                                    <th>S·ªë l∆∞·ª£ng</th>
                                    <th>Thao t√°c</th>
                                </tr>
                            </thead>
                            <tbody>
                                <tr th:each="sanPhamChiTiet : ${sanPhamChiTiet}">
                                    <td><img th:src="${sanPhamChiTiet.hinhAnh}" alt="H√¨nh ·∫£nh"
                                            style="width:80px;height:50px;"></td>
                                    <td th:text="${sanPhamChiTiet.idSanPham.tenSanPham}"></td>
                                    <td
                                        th:text="${#numbers.formatDecimal(sanPhamChiTiet.giaBan, 0, 'COMMA', 0, 'POINT')} + ' VNƒê'">
                                    </td>
                                    <td th:text="${sanPhamChiTiet.soLuong}"></td>
                                    <td>
                                        <button class="btn btn-success btnThemVaoHoaDon"
                                            th:data-id="${sanPhamChiTiet.id}"
                                            th:data-ten="${sanPhamChiTiet.idSanPham.tenSanPham}"
                                            th:data-gia="${sanPhamChiTiet.giaBan}"
                                            th:data-hinh="${sanPhamChiTiet.hinhAnh}">
                                            Th√™m
                                        </button>
                                    </td>
                                </tr>
                            </tbody>
                        </table>
                    </div>
                    <nav aria-label="Page navigation" class="mt-3">
                        <ul class="pagination justify-content-center">
                            <li class="page-item" th:classappend="${currentPageCTSP == 0} ? 'disabled' : ''">
                                <a th:href="@{/hoaDon/detailhoadononlinect(page=${currentPageCTSP - 1}, size=${10})}"
                                    class="page-link">¬´</a>
                            </li>
                            <li class="page-item" th:each="i : ${#numbers.sequence(0, totalPagesCTSP - 1)}"
                                th:classappend="${i == currentPageCTSP} ? 'active' : ''">
                                <a th:href="@{/hoaDon/detailhoadononlinect(page=${i}, size=${10})}" class="page-link"
                                    th:text="${i + 1}"></a>
                            </li>
                            <li class="page-item"
                                th:classappend="${currentPageCTSP + 1 == totalPagesCTSP} ? 'disabled' : ''">
                                <a th:href="@{/hoaDon/detailhoadononlinect(page=${currentPageCTSP+1}, size=${10})}"
                                    class="page-link">¬ª</a>
                            </li>
                        </ul>
                    </nav>
                </div>
            </div>
        </div>

        <div class="modal fade" id="capnhatlichsu" tabindex="-1" aria-labelledby="exampleModalLabel" aria-hidden="true">
            <div class="modal-dialog modal-sm" style="max-width: 700px;"> <!-- S·ª≠ d·ª•ng modal-md ƒë·ªÉ nh·ªè h∆°n -->
                <div class="modal-content">
                    <div class="modal-header">
                        <h5 class="modal-title fs-5" id="exampleModalLabel">C·∫≠p nh·∫≠t th√¥ng tin</h5>
                        <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
                    </div>
                    <div class="modal-body">

                        <!-- Th√¥ng tin kh√°ch h√†ng -->
                        <div th:attr="disabled=${hoaDon.trangThai==2}">
                            <h5>Th√¥ng tin kh√°ch h√†ng:</h5>
                            <div class="row row-cols-2">
                                <div class="col mb-3">
                                    <label for="tenKhachHang" class="form-label">T√™n kh√°ch h√†ng <span
                                            class="text-danger">*</span></label>
                                    <input type="text" class="form-control w-80" id="tenKhachHang"
                                        th:field="${hoaDon.tenNguoiNhan}" required />
                                </div>
                                <div class="col mb-3">
                                    <label for="sdtKhachHang" class="form-label">S·ªë ƒëi·ªán tho·∫°i <span
                                            class="text-danger">*</span></label>
                                    <input type="text" class="form-control w-80" id="sdtKhachHang"
                                        th:field="${hoaDon.sdtNguoiNhan}" required />
                                    <div class="invalid-feedback">S·ªë ƒëi·ªán tho·∫°i kh√¥ng ƒë√∫ng ƒë·ªãnh d·∫°ng</div>

                                </div>
                                <div class="col mb-3">
                                    <label for="tinhThanhPho" class="form-label">T·ªânh/Th√†nh ph·ªë<span
                                            class="text-danger">*</span></label>
                                    <input type="text" class="form-control w-80" id="tinhThanhPho"
                                        th:field="${hoaDon.tinhThanhPho}" required />
                                </div>
                                <div class="col mb-3">
                                    <label for="quanHuyen" class="form-label">Qu·∫≠n/Huy·ªán<span
                                            class="text-danger">*</span></label>
                                    <input type="text" class="form-control w-80" id="quanHuyen"
                                        th:field="${hoaDon.quanHuyen}" required />
                                </div>

                            </div>
                            <div class="mb-3">
                                <label for="phuongXa" class="form-label">Ph∆∞·ªùng/X√£<span
                                        class="text-danger">*</span></label>
                                <input type="text" class="form-control w-80" id="phuongXa" th:field="${hoaDon.phuongXa}"
                                    required />
                            </div>

                        </div>

                        <!-- Th√¥ng tin giao h√†ng (Hi·ªÉn th·ªã n·∫øu tr·∫°ng th√°i == 3) -->
                        <div th:if="${hoaDon.trangThai==3}">
                            <h5>Th√¥ng tin ƒë∆°n v·ªã giao h√†ng:</h5>

                            <div class="row row-cols-2">
                                <div class="col mb-3">
                                    <label for="tenNguoiGiao" class="form-label">T√™n ng∆∞·ªùi giao<span
                                            class="text-danger">*</span></label>
                                    <input type="text" class="form-control w-80" id="tenNguoiGiao"
                                        th:field="${hoaDon.tenNguoiGiao}" required />
                                </div>
                                <div class="col mb-3">
                                    <label for="sdtNguoiGiao" class="form-label">SƒêT ng∆∞·ªùi giao<span
                                            class="text-danger">*</span></label>
                                    <input type="text" class="form-control w-80" id="sdtNguoiGiao"
                                        th:field="${hoaDon.sdtNguoiGiao}" required />
                                    <div class="invalid-feedback">S·ªë ƒëi·ªán tho·∫°i kh√¥ng ƒë√∫ng ƒë·ªãnh d·∫°ng</div>
                                </div>
                                <div class=" col  mb-3">
                                    <label for="donViGiaoHang" class="form-label">ƒê∆°n v·ªã giao h√†ng<span
                                            class="text-danger">*</span></label>
                                    <input type="text" class="form-control w-80" id="donViGiaoHang"
                                        th:field="${hoaDon.donViGiaoHang}" required />
                                </div>
                            </div>

                        </div>

                    </div>

                    <!-- N√∫t l∆∞u ·ªü modal-footer ƒë·ªÉ g·ªçn h∆°n -->
                    <div class="modal-footer">
                        <button type="submit" id="btn-luu-thay-doi" class="btn btn-primary">L∆∞u thay ƒë·ªïi</button>
                    </div>
                </div>
            </div>
        </div>

        <!--    Th√™m s·∫£n ph·∫©m v√†o h√≥a ƒë∆°n-->
        <script>
            let notyf = new Notyf({
                duration: 3000,
                position: { x: "right", y: "top" },
            });

            function getIdHoaDonFromPath() {
                let pathParts = window.location.pathname.split("/");
                let idHoaDon = pathParts.pop();

                if (!idHoaDon || isNaN(idHoaDon)) {
                    console.error("Kh√¥ng t√¨m th·∫•y ID h√≥a ƒë∆°n!");
                    return null;
                }
                return parseInt(idHoaDon); // ƒê·∫£m b·∫£o ID l√† s·ªë nguy√™n
            }



            document.addEventListener("DOMContentLoaded", function () {
                document.querySelectorAll(".btnThemVaoHoaDon").forEach(button => {
                    button.addEventListener("click", function () {
                        let idChiTietSanPham = parseInt(this.getAttribute("data-id"));
                        let tenSanPham = this.getAttribute("data-ten");
                        let giaBan = parseFloat(this.getAttribute("data-gia"));
                        let hinhAnh = this.getAttribute("data-hinh");

                        let soLuong = 1; // M·∫∑c ƒë·ªãnh l√† 1
                        let idHoaDon = getIdHoaDonFromPath(); // L·∫•y ID t·ª´ URL

                        if (!idHoaDon) {
                            alert("Kh√¥ng t√¨m th·∫•y ID h√≥a ƒë∆°n tr√™n URL. Vui l√≤ng ki·ªÉm tra l·∫°i!");
                            return;
                        }

                        fetch("/hoadononline/them-chi-tiet", {
                            method: "POST",
                            headers: { "Content-Type": "application/json" },
                            body: JSON.stringify({
                                idHoaDon: idHoaDon,  // Truy·ªÅn ID tr·ª±c ti·∫øp
                                idChiTietSanPham: idChiTietSanPham,
                                soLuong: soLuong,
                                donGia: giaBan,
                                trangThai: 1
                            })
                        })
                            .then(response => response.json()) // Chuy·ªÉn response th√†nh JSON
                            .then(data => {
                                if (data.success) {
                                    alert("Th√™m s·∫£n ph·∫©m th√†nh c√¥ng!");

                                    let tbody = document.querySelector("tbody");
                                    let existingRow = tbody.querySelector(`tr[data-id="${idChiTietSanPham}"]`);

                                    if (existingRow) {
                                        // N·∫øu s·∫£n ph·∫©m ƒë√£ t·ªìn t·∫°i, c·∫≠p nh·∫≠t s·ªë l∆∞·ª£ng
                                        let input = existingRow.querySelector(".soLuongInput");
                                        input.value = parseInt(input.value) + 1;
                                    } else {
                                        // N·∫øu s·∫£n ph·∫©m ch∆∞a t·ªìn t·∫°i, th√™m m·ªõi
                                        let newRow = `
                                <tr data-id="${idChiTietSanPham}">
                                    <td><img src="${hinhAnh}" alt="H√¨nh ·∫£nh" style="width:80px;height:50px;"></td>
                                    <td>${tenSanPham}</td>
                                    <td>${giaBan.toLocaleString()} VNƒê</td>
                                    <td>
                                        <input type="number" class="form-control soLuongInput" style="width: 80px;" value="1" min="1"/>
                                    </td>
                                    <td>
                                        <button class="btn btn-danger btnXoaSanPham">X√≥a</button>
                                    </td>
                                </tr>`;
                                        tbody.insertAdjacentHTML("beforeend", newRow);
                                    }
                                } else {
                                    throw new Error(data.message || "L·ªói kh√¥ng x√°c ƒë·ªãnh!");
                                }
                            })
                            .catch(error => {
                                console.error("L·ªói:", error);
                                alert("L·ªói: " + error.message);
                            });

                        // ƒê√≥ng modal sau khi th√™m
                        var modal = new bootstrap.Modal(document.getElementById('modalSanPham'));
                        modal.hide();
                    });
                });
            });
            document.getElementById('huyhoadon').addEventListener('click', function () {
                var idHD = getIdHoaDonFromPath();
                var note = document.getElementById('notehuyhoadon').value;
                if (note.trim() === '') {
                    alert('Kh√¥ng ƒë∆∞·ª£c ƒë·ªÉ tr·ªëng ghi ch√∫');
                    return;
                }
                if (confirm('B·∫°n c√≥ ch·∫Øc mu·ªën h·ªßy h√≥a ƒë∆°n kh√¥ng?')) {
                    let formData = {
                        idhoadon: idHD,
                        ghichu: note,
                        trangthai: 6
                    }
                    $.ajax({
                        type: 'POST',
                        contentType: 'application/json',
                        url: '/hoadononline/doi-trang-thai', // ƒê∆∞·ªùng d·∫´n ƒë·∫øn endpoint c·ªßa controller Spring
                        data: JSON.stringify(formData), // Chuy·ªÉn ƒë·ªïi ƒë·ªëi t∆∞·ª£ng th√†nh JSON
                        success: function (response) {
                            console.log(response.message)
                            alert(response.message);
                            $('#cancelModal').modal('hide');
                            // ƒêƒÉng k√Ω s·ª± ki·ªán ch·ªâ 1 l·∫ßn ngo√†i Ajax
                            document.getElementById("confirmCancel").addEventListener("click", function () {
                                document.getElementById("note").value = "";
                            });
                            // Chuy·ªÉn h∆∞·ªõng trang
                            window.location.href = '/hoadononline/detailhoadononlinect/' + idHD;
                            // Th·ª±c hi·ªán c√°c thao t√°c kh√°c n·∫øu c·∫ßn
                        },
                        error: function (error) {
                            if (error.responseJSON && error.responseJSON.message) {
                                alert(error.responseJSON.message);
                            } else if (error.responseText) {
                                alert(error.responseText)
                            } else {
                                alert("ƒê√£ x·∫£y ra l·ªói, vui l√≤ng th·ª≠ l·∫°i");
                            }; document.getElementById("confirmCancel").addEventListener("click", function () {
                                document.getElementById("note").value = "";
                            });
                            window.location.href = '/hoadononline/detailhoadononlinect/' + idHD;
                            // ƒêƒÉng k√Ω s·ª± ki·ªán ch·ªâ 1 l·∫ßn ngo√†i Ajax
                        }
                    });
                }

            });
            document.getElementById('confirmCancel').addEventListener('click', function () {
                var note = document.getElementById('note').value;
                var status = parseInt(document.getElementById('status').value);
                var idHD = getIdHoaDonFromPath();


                if (note.trim() === '') {
                    alert('Ghi ch√∫ kh√¥ng ƒë∆∞·ª£c ƒë·ªÉ tr·ªëng.');
                    return;
                }
                if (!status) {
                    alert('Vui l√≤ng ch·ªçn tr·∫°ng th√°i.');
                    return;
                }

                var ttdoi;
                if (status === 2 || status === 10) {
                    ttdoi = 3;
                } else if (status === 3) {
                    ttdoi = 4;
                } else if (status === 4) {
                    ttdoi = 5;
                } else {
                    // Tr∆∞·ªùng h·ª£p m·∫∑c ƒë·ªãnh n·∫øu kh√¥ng kh·ªõp v·ªõi b·∫•t k·ª≥ gi√° tr·ªã n√†o
                    alert('Tr·∫°ng th√°i kh√¥ng h·ª£p l·ªá.');
                    return;
                }
                var formData = {
                    idHoaDon: idHD,
                    ghiChu: note,
                    trangThai: ttdoi
                };

                if (confirm('B·∫°n c√≥ mu·ªën ƒë·ªïi tr·∫°ng th√°i kh√¥ng ?')) {
                    // Th·ª±c hi·ªán AJAX ho·∫∑c h√†nh ƒë·ªông ƒë·ªÉ thay ƒë·ªïi tr·∫°ng th√°i h√≥a ƒë∆°n
                    // V√≠ d·ª• s·ª≠ d·ª•ng AJAX
                    $.ajax({
                        type: 'POST',
                        contentType: 'application/json',
                        url: '/hoadononline/doi-trang-thai', // ƒê∆∞·ªùng d·∫´n ƒë·∫øn endpoint c·ªßa controller Spring
                        data: JSON.stringify(formData), // Chuy·ªÉn ƒë·ªïi ƒë·ªëi t∆∞·ª£ng th√†nh JSON
                        success: function (response) {
                            alert(response.message);
                            $('#cancelModal').modal('hide');
                            // ƒêƒÉng k√Ω s·ª± ki·ªán ch·ªâ 1 l·∫ßn ngo√†i Ajax
                            document.getElementById("confirmCancel").addEventListener("click", function () {
                                document.getElementById("note").value = "";
                            });
                            // Chuy·ªÉn h∆∞·ªõng trang
                            window.location.href = '/hoadononline/detailhoadononlinect/' + idHD;
                            // Th·ª±c hi·ªán c√°c thao t√°c kh√°c n·∫øu c·∫ßn
                        },
                        error: function (xhr) {
                            console.log(xhr);
                            // Ki·ªÉm tra xem l·ªói c√≥ ph·∫£i l√† JSON kh√¥ng
                            if (xhr.responseJSON && xhr.responseJSON.message) {
                                alert(xhr.responseJSON.message);
                            } else if (xhr.responseText) {
                                // Tr∆∞·ªùng h·ª£p kh√¥ng ph·∫£i JSON, l·∫•y responseText
                                alert(xhr.responseText);
                            } else {
                                alert("ƒê√£ x·∫£y ra l·ªói, vui l√≤ng th·ª≠ l·∫°i.");
                            }
                            document.getElementById("confirmCancel").addEventListener("click", function () {
                                document.getElementById("note").value = "";
                            });
                            window.location.href = '/hoadononline/detailhoadononlinect/' + idHD;
                        }
                    });
                }
            });
            document.getElementById("btn-luu-thay-doi").addEventListener("click", function (e) {
                let isValid = true;

                document.querySelectorAll("input[required]").forEach(input => {
                    if (!input.value.trim()) {
                        input.classList.add("is-invalid"); // Hi·ªÉn th·ªã l·ªói
                        isValid = false;
                    } else {
                        input.classList.remove("is-invalid"); // X√≥a l·ªói n·∫øu ƒë√£ nh·∫≠p
                    }
                });

                if (!isValid) {
                    e.preventDefault(); // NgƒÉn form g·ª≠i n·∫øu c√≥ l·ªói
                    notyf.error("Vui l√≤ng nh·∫≠p ƒë·∫ßy ƒë·ªß th√¥ng tin!");
                    return;
                }
                e.preventDefault(); // NgƒÉn ch·∫∑n reload trang
                let sdtNguoiGiao = document.getElementById("sdtNguoiGiao").value.trim();
                let phoneInput = document.getElementById("sdtKhachHang");
                let phoneNumber = phoneInput.value.trim();

                // Bi·ªÉu th·ª©c ch√≠nh quy ki·ªÉm tra s·ªë ƒëi·ªán tho·∫°i Vi·ªát Nam h·ª£p l·ªá
                let phoneRegex = /^(03|05|07|08|09)\d{8}$/;

                if (!phoneRegex.test(phoneNumber)) {
                    phoneInput.classList.add("is-invalid"); // Hi·ªÉn th·ªã l·ªói
                    notyf.error("S·ªë ƒëi·ªán tho·∫°i kh√¥ng h·ª£p l·ªá!");
                } else if (!phoneRegex.test(sdtNguoiGiao)) {
                    document.getElementById("sdtNguoiGiao").classList.add("is-invalid");
                    notyf.error("S·ªë ƒëi·ªán tho·∫°i ng∆∞·ªùi giao h√†ng kh√¥ng h·ª£p l·ªá!");
                }
                else {
                    // N·∫øu h·ª£p l·ªá, c√≥ th·ªÉ g·ª≠i AJAX
                    updateHoaDon();
                }

            });
            function updateHoaDon() {
                var idHD = getIdHoaDonFromPath(); // H√†m l·∫•y ID t·ª´ URL ho·∫∑c ngu·ªìn kh√°c
                let tenNguoiGiao = document.getElementById("tenNguoiGiao").value.trim();
                let sdtNguoiGiao = document.getElementById("sdtNguoiGiao").value.trim();
                let donViGiaoHang = document.getElementById("donViGiaoHang").value.trim();
                if (tenNguoiGiao == '' || sdtNguoiGiao == '' || donViGiaoHang == '') {
                    tenNguoiGiao = 'Kh√¥ng c√≥';
                    sdtNguoiGiao = 'Kh√¥ng c√≥';
                    donViGiaoHang = 'Kh√¥ng c√≥';

                }
                let hoaDon = {
                    id: idHD,
                    tenKhachHang: $("#tenKhachHang").val(),
                    sdt: $("#sdtKhachHang").val(),
                    tinhThanhPho: $("#tinhThanhPho").val(),
                    quanHuyen: $("#quanHuyen").val(),
                    phuongXa: $("#phuongXa").val(),
                    tenNguoiGiao: tenNguoiGiao,
                    sdtNguoiGiao: sdtNguoiGiao,
                    donViGiaoHang: donViGiaoHang
                };

                fetch('/hoadononline/updatehoadon', {
                    method: "POST",
                    headers: {
                        "Content-Type": "application/json"
                    },
                    body: JSON.stringify(hoaDon)
                })
                    .then(response => {
                        if (!response.ok) {
                            return response.json().then(data => {
                                throw new Error(data.message || "C√≥ l·ªói x·∫£y ra");
                            });
                        }
                        return response.json();
                    })
                    .then(data => {
                        if (data.message) {
                            notyf.success(data.message || "C·∫≠p nh·∫≠t th√†nh c√¥ng!");
                            $("#capnhatlichsu").modal("hide"); // ·∫®n modal
                            setTimeout(() => {
                                location.reload(); // Load l·∫°i trang ƒë·ªÉ c·∫≠p nh·∫≠t d·ªØ li·ªáu
                            }, 2000);
                        } else {
                            notyf.error("C·∫≠p nh·∫≠t th·∫•t b·∫°i!");
                            $("#capnhatlichsu").modal("hide"); // ·∫®n modal
                        }
                    })
                    .catch(error => {
                        console.error("L·ªói khi c·∫≠p nh·∫≠t:", error);
                        notyf.error("L·ªói c·∫≠p nh·∫≠t: " + error.message);
                    });
            }
            document.addEventListener("DOMContentLoaded", function () {
                document.querySelectorAll(".btnXoaSanPham").forEach(button => {
                    button.addEventListener("click", function () {
                        let idHoaDon = this.getAttribute("data-id-hoa-don");
                        let idChiTietSanPham = this.getAttribute("data-id-san-pham");

                        if (!idHoaDon || !idChiTietSanPham) {
                            alert("L·ªói: Kh√¥ng l·∫•y ƒë∆∞·ª£c ID s·∫£n ph·∫©m ho·∫∑c h√≥a ƒë∆°n!");
                            return;
                        }

                        if (!confirm("B·∫°n c√≥ ch·∫Øc mu·ªën x√≥a s·∫£n ph·∫©m n√†y kh·ªèi h√≥a ƒë∆°n?")) {
                            return;
                        }

                        fetch(`/hoadononline/xoa-chi-tiet/${idHoaDon}/${idChiTietSanPham}`, {
                            method: "DELETE"
                        })
                            .then(response => response.json())
                            .then(data => {
                                if (data.success) {
                                    alert("X√≥a th√†nh c√¥ng!");
                                    this.closest("tr").remove(); // X√≥a d√≤ng kh·ªèi b·∫£ng
                                } else {
                                    alert("L·ªói: " + data.message);
                                }
                            })
                            .catch(error => {
                                console.error("L·ªói khi x√≥a:", error);
                                alert("L·ªói h·ªá th·ªëng!");
                            });
                    });
                });
            });

        </script>


<!--        X√°c nh·∫≠n h√≥a ƒë∆°n chi ti·∫øt-->
        <script th:inline="javascript">
            function xacNhanHoaDon() {
                let hoaDonId = [[${hoaDon.id}]]; // L·∫•y ID h√≥a ƒë∆°n t·ª´ Thymeleaf

                fetch('/hoadononline/xacnhan/' + hoaDonId, {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                })
                    .then(response => response.json())
                    .then(data => {
                        if (!data.success) {
                            alert('L·ªói: ' + data.message);
                        }
                    })
                    .catch(error => console.error('L·ªói:', error));
            }
        </script>

<!--        In h√≥a ƒë∆°n-->
        <script>
            function openInvoicePage(button) {
                var hoaDonId = button.value; // L·∫•y ID h√≥a ƒë∆°n t·ª´ value c·ªßa n√∫t
                if (hoaDonId) {
                    var url = "/hoadononline/in-hoadon/" + hoaDonId;
                    window.open(url, "_blank"); // M·ªü trang in h√≥a ƒë∆°n trong tab m·ªõi
                } else {
                    alert("Kh√¥ng t√¨m th·∫•y h√≥a ƒë∆°n!");
                }
            }
        </script>


    </div>
</body>

</html>