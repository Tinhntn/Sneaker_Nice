<html lang="en" xmlns:th="http://www.thymeleaf.org" xmlns:layout="http://www.ultraq.net.nz/thymeleaf/layout"
    layout:decorate="~{layout/mainUser.html}">

<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <meta http-equiv="X-UA-Compatible" content="ie=edge">
    <title>Thông tin sản phẩm</title>

    <!-- CSS Bootstrap -->
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0-alpha1/dist/css/bootstrap.min.css" rel="stylesheet">
    <!-- FontAwesome for icons -->
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.0.0-beta3/css/all.min.css">



</head>

<body>

    <div layout:fragment="content">
        <section class="ftco-section">
            <div class="container mt-5">
                <div class="row">
                    <div class="col-lg-6 mb-5 ftco-animate">
                        <a class="image-popup prod-img-bg"><img id="productImage" th:src="${chiTietSanPham.hinhAnh}"
                                class="img-fluid" alt="Colorlib Template"></a>
                    </div>
                    <div class="col-lg-6 product-details pl-md-5 ftco-animate">
                        <h2 class="mb-4">Thông tin sản phẩm</h2>
                        <div class="rating d-flex">
                            <p class="text-left mr-4">
                                <a href="#" class="mr-2">5.0</a>
                                <i class="fas fa-star"></i>
                                <i class="fas fa-star"></i>
                                <i class="fas fa-star"></i>
                                <i class="fas fa-star"></i>
                                <i class="fas fa-star"></i>
                            </p>

                        </div>

                        <h4 class="mb-3"
                            th:text="${chiTietSanPham.idSanPham.tenSanPham + ' ' + chiTietSanPham.idSanPham.idHang.tenHang + ' ' + chiTietSanPham.idSanPham.idDanhMuc.tenDanhMuc + ' ' + chiTietSanPham.idSanPham.idChatLieu.tenChatLieu}">
                        </h4>
                        <h4 class="mb-3" id="idMauSac" th:data-mauSac="${chiTietSanPham.idMauSac.id}"
                            th:text="${chiTietSanPham.idMauSac.tenMauSac}">
                        </h4>
                        <h4 id="giaBan" class="price mb-3"
                            th:text="'Giá: ' +${#numbers.formatInteger(chiTietSanPham.giaBan,3,'COMMA')} + ' VND'"></h4>
                        <h4 class="mb-4" id="soLuong"
                            th:text="${chiTietSanPham.soLuong != null ? 'Còn hàng: ' + chiTietSanPham.soLuong : 'Hết hàng'}">
                        </h4>
                        <!-- Các button chọn Size -->
                        <div id="sizeButtons" class="mb-4">
                            <div>
                                <button type="button" id="selectedSize" th:each="size : ${lstSize}"
                                    th:data-idSize="${size.id}" th:text="${size.tenSize}"
                                    th:class="${(chiTietSanPham != null and size.id == chiTietSanPham.idSize.id) ? 'btn btn-secondary size-btn active' : 'btn btn-outline-secondary size-btn'}"
                                    onclick="selectSize(this)">
                                </button>
                            </div>
                        </div>
                        <!-- Các button chọn Màu sắc -->
                        <div id="mauSacButtons" class="mb-4">
                            <div>
                                <button type="button" id="selectedMauSac" th:each="ms : ${lstMauSac}"
                                    th:data-idMauSac="${ms.id}" th:text="${ms.tenMauSac}"
                                    th:data-idCTSP="${chiTietSanPham.id}"
                                    th:class="${(chiTietSanPham != null and ms.id == chiTietSanPham.idMauSac.id) ? 'btn btn-secondary btn-mau-sac active' : 'btn btn-outline-secondary btn-mau-sac'}"
                                    onclick="selectMauSac(this)">
                                </button>
                            </div>
                        </div>

                        <div class="input-group col-md-6 d-flex mb-3">
                            <span class="input-group-btn mr-2">
                                <button type="button" class="quantity-left-minus btn" data-type="minus" data-field="">
                                    <i class="ion-ios-remove"></i>
                                </button>
                            </span>

                            <input type="number" id="quantity" name="quantity"
                                class="quantity form-control input-number" value="1" min="1">
                            <span class="input-group-btn ml-2">
                                <button type="button" class="quantity-right-plus btn" data-type="plus" data-field="">
                                    <i class="ion-ios-add"></i>
                                </button>
                            </span>

                        </div>
                        <!-- Các button Thanh toán và Thêm vào giỏ hàng -->
                        <div class="input-group col-md-6 d-flex mb-3">
                            <form th:action="@{/giohang/addGHCT}" method="post" class="d-inline">
                                <a id="themVaoGioHang" class="btn btn-primary btnThemVaoGioHang  py-3 px-5 ">Thêm
                                    vào
                                    giỏ hàng
                                </a>
                                <br>
                                <a id="muaNgay" class="btn btn-primary btnMuaNgay py-3 px-5">Mua ngay</a>

                            </form>
                        </div>
                        <script th:inline="javascript">
                            $(document).ready(function () {
                                $(".quantity-right-plus").click(function () {
                                    var quantityInput = $("#quantity");
                                    var quantity = parseInt(quantityInput.val());
                                    quantityInput.val(quantity + 1);

                                });

                                $(".quantity-left-minus").click(function () {
                                    var quantityInput = $("#quantity");
                                    var quantity = parseInt(quantityInput.val());
                                    var min = parseInt(quantityInput.attr("min"));

                                    if (quantity > min) {
                                        quantityInput.val(quantity - 1);
                                    }
                                });
                            });
                            var notyf = new Notyf({ ripple: true });

                            function selectSize(button) {
                                // Xóa class active khỏi tất cả các nút size

                                document.querySelectorAll('.size-btn').forEach(btn => {
                                    btn.classList.remove('active');
                                });

                                // Đánh dấu nút được chọn
                                button.classList.add('active');

                                // Cập nhật giá trị size được chọn
                                document.getElementById("selectedSize").value = button.getAttribute("data-idSize");

                            }

                            function selectMauSac(button) {
                                // Xóa class active khỏi tất cả các nút màu sắc
                                document.querySelectorAll('.btn-mau-sac').forEach(btn => {
                                    btn.classList.remove('active');


                                });
                                // Đánh dấu nút được chọn
                                button.classList.add('active');
                            }





                            document.addEventListener("DOMContentLoaded", function () {
                                updateCartCount();
                                var combinations = /*[[${lstCTSP}]]*/[];
                                const colorButtons = document.querySelectorAll(".btn-mau-sac");
                                const sizeButtons = document.querySelectorAll(".size-btn");
                                const quantityText = document.getElementById("soLuong");
                                const giaBan = document.getElementById('giaBan');

                                let selectedColor = null;
                                let selectedSize = null;
                                function updateQuantity() {
                                    let idMauSac = document.querySelector(".btn-mau-sac.active")?.getAttribute("data-idMauSac") || "";
                                    let idSize = document.querySelector(".size-btn.active")?.getAttribute("data-idSize") || "";
                                    let idSanPham = /*[[${chiTietSanPham != null && chiTietSanPham.idSanPham != null ? chiTietSanPham.idSanPham.id : ''}]]*/ "";
                                    let query = new URLSearchParams({ idSanPham, idSize, idMauSac }).toString();

                                    fetch(`/Sneakers_Nice/lay-combination?${query}`, {
                                        method: "GET",
                                        headers: { "Content-Type": "application/json" }
                                    })
                                        .then(response => response.json())
                                        .then(data => {
                                            if (data && data.chiTietSanPham !== undefined) {
                                                quantityText.innerText = `Còn hàng: ${data.chiTietSanPham.soLuong}`;
                                                giaBan.innerText = `Giá: ${Number(data.chiTietSanPham.giaBan).toLocaleString('vi-VN')} VNĐ`;
                                                document.getElementById("idMauSac").innerText = `${data.chiTietSanPham.idMauSac.tenMauSac}`;
                                                document.getElementById("idMauSac").setAttribute("data-mauSac", `${data.chiTietSanPham.idMauSac.id}`);
                                            } else {
                                                giaBan.innerText = `Giá: ${Number(data.chiTietSanPham.giaBan).toLocaleString('vi-VN')} VNĐ`;
                                                document.getElementById("idMauSac").innerText = `${data.chiTietSanPham.idMauSac.tenMauSac}`;
                                                document.getElementById("idMauSac").setAttribute("data-mauSac", `${data.chiTietSanPham.idMauSac.id}`)
                                                quantityText.innerText = "Hết hàng";

                                            }
                                        })
                                        .catch(error => {
                                            console.error("Lỗi:", error);
                                        });
                                }


                                function updateSizes() {
                                    sizeButtons.forEach((btn) => {
                                        const size = btn.getAttribute("data-idSize");
                                        const isAvailable = combinations.some(c => c.idMauSac.id == selectedColor && c.idSize.id == size);
                                        btn.disabled = !isAvailable;
                                        if (!isAvailable && btn.classList.contains("active")) {
                                            btn.classList.remove("active");
                                        }
                                    });
                                }

                                function updateColors() {
                                    colorButtons.forEach((btn) => {
                                        const color = btn.getAttribute("data-idMauSac");
                                        const isAvailable = combinations.some(c => c.idSize.id == selectedSize && c.idMauSac.id == color);
                                        btn.disabled = !isAvailable;
                                        if (!isAvailable && btn.classList.contains("active")) {
                                            btn.classList.remove("active");
                                        }
                                    });
                                }

                                colorButtons.forEach(btn => {
                                    btn.addEventListener("click", function () {
                                        selectedColor = this.getAttribute("data-idMauSac");
                                        updateSizes();
                                        if (selectedColor && selectedSize) {
                                            updateQuantity();
                                        }
                                    });
                                });

                                sizeButtons.forEach(btn => {
                                    btn.addEventListener("click", function () {
                                        selectedSize = this.getAttribute("data-idSize");
                                        updateColors();
                                        if (selectedColor && selectedSize) {
                                            updateQuantity();
                                        }
                                    });
                                });
                                document.addEventListener("click", function (event) {
                                    // Kiểm tra nếu phần tử được click không phải là các nút size hoặc màu sắc
                                    if (!event.target.classList.contains("btn-mau-sac") && !event.target.classList.contains("size-btn")) {
                                        selectedColor = null;
                                        selectedSize = null;

                                        // Bật lại tất cả các nút
                                        sizeButtons.forEach(btn => btn.disabled = false);
                                        colorButtons.forEach(btn => btn.disabled = false);
                                    }
                                });

                            });

                            document.querySelectorAll(".btn-mau-sac").forEach(button => {
                                button.addEventListener("click", function () {
                                    // Lấy id màu sắc từ nút được click
                                    const idMauSac = this.getAttribute("data-idMauSac");

                                    // Cập nhật value cho input ẩn
                                    document.getElementById("selectedMauSac").value = idMauSac;

                                    // Lấy id sản phẩm từ Thymeleaf (tùy bạn dùng kiểu nào)
                                    const idSP = /*[[${chiTietSanPham != null && chiTietSanPham.idSanPham!=null ? chiTietSanPham.idSanPham.id : ''}]]*/ "";

                                    // Gọi API để lấy ảnh theo idSP và idMauSac
                                    fetch(`/Sneakers_Nice/layAnh?idSP=${idSP}&idMauSac=${idMauSac}`)
                                        .then(response => response.json())
                                        .then(data => {
                                            if (data && data.hinhAnh) {
                                                document.getElementById("productImage").src = data.hinhAnh;
                                            }
                                        })
                                        .catch(error => {
                                            console.error("Lỗi khi lấy ảnh:", error);
                                            notyf.error('Có lỗi xảy ra khi cập nhật ảnh!');
                                        });

                                    // Cập nhật class active cho nút được chọn
                                    document.querySelectorAll(".btn-mau-sac").forEach(btn => btn.classList.remove("active"));
                                    this.classList.add("active");
                                });
                            });


                            $("#themVaoGioHang").click(async function themSanPhamVaoGioHang() {
                                var idMauSac = $(".btn-mau-sac.active").attr("data-idMauSac");
                                var idSize = $(".size-btn.active").attr("data-idSize");
                                var soLuong = document.getElementById("quantity").value;
                                var idSanPham = /*[[${chiTietSanPham != null && chiTietSanPham.idSanPham != null ? chiTietSanPham.idSanPham.id : ''}]]*/ "";

                                if (soLuong < 1) {
                                    notyf.error('Số lượng phải lớn hơn 0');
                                    return;
                                } else if (idSize == null) {
                                    notyf.error('Vui lòng chọn size');
                                    return;
                                }
                                else if (idMauSac == null) {
                                    notyf.error('Vui lòng chọn màu sắc');
                                    return;
                                }
                                else {
                                    let formData = {
                                        idSanPham: idSanPham,
                                        idSize: idSize,
                                        idMauSac: idMauSac,
                                        soLuong: soLuong
                                    };
                                    let response = await fetch(`/gio-hang/them-vao-gio-hang`, {
                                        method: "POST",
                                        headers: { "Content-Type": "application/json" },
                                        body: JSON.stringify(formData)
                                    });
                                    if (!response.ok) {
                                        let errorData = {};
                                        try {
                                            errorData = await response.json();
                                        } catch (e) {
                                            console.error("Không parse được lỗi JSON:", e);
                                        }

                                        const message = errorData.message || "Có lỗi xảy ra";

                                        if (response.status === 401) {
                                            notyf.error(errorData.message);
                                            setTimeout(() => window.location.href = "/dang-nhap", 2000);
                                            return;
                                        }
                                    }
                                    else if (response.status === 200) {
                                        let data = await response.json();
                                        if (data && data.message) {
                                            updateCartCount();
                                            notyf.success(data.message);
                                        } else {
                                            updateCartCount();
                                            notyf.success('Thêm sản phẩm vào giỏ hàng thành công');
                                            return;
                                        }
                                    }
                                }
                            });
                            $("#muaNgay").click(async function muaNgay() {
                                var idMauSac = $(".btn-mau-sac.active").attr("data-idMauSac");
                                var idSize = $(".size-btn.active").attr("data-idSize");
                                var soLuong = document.getElementById("quantity").value;
                                var idSanPham = /*[[${chiTietSanPham != null && chiTietSanPham.idSanPham != null ? chiTietSanPham.idSanPham.id : ''}]]*/ "";

                                if (soLuong < 1) {
                                    notyf.error('Số lượng phải lớn hơn 0');
                                    return;
                                } else if (idSize == null) {
                                    notyf.error('Vui lòng chọn size');
                                    return;
                                }
                                else if (idMauSac == null) {
                                    notyf.error('Vui lòng chọn màu sắc');
                                    return;
                                }
                                else {
                                    let formData = {
                                        idSanPham: idSanPham,
                                        idSize: idSize,
                                        idMauSac: idMauSac,
                                        soLuong: soLuong
                                    };
                                    let response = await fetch(`/gio-hang/them-vao-gio-hang`, {
                                        method: "POST",
                                        headers: { "Content-Type": "application/json" },
                                        body: JSON.stringify(formData)
                                    });
                                    if (!response.ok) {
                                        let errorData;
                                        try {
                                            errorData = await response.json(); // Lấy dữ liệu lỗi từ server
                                        } catch (e) {
                                            errorData = { message: "Lỗi không xác định" }; // Nếu không lấy được dữ liệu
                                        }
                                        const message = errorData.message || "Có lỗi xảy ra";

                                        if (response.status === 401) {
                                            notyf.error(errorData.message);
                                            setTimeout(() => window.location.href = "/dang-nhap", 2000);
                                            return;
                                        }

                                    } else if (response.status === 200) {
                                        window.location.href = "/gio-hang/thanh-toan"
                                    }

                                }

                            });
                        </script>
                    </div>


        </section>
    </div>
</body>

</html>