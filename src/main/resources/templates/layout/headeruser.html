<div th:fragment="header">
    <!--  cs Tìm Kiem an-->
    <style>
        /* Trạng thái mặc định (chưa cuộn) */
        #ftco-navbar .input-group-text,
        #ftco-navbar .form-control {
            background-color: #5a5c69 !important;
            /* Màu nền tối của navbar */
            color: #333 !important;
            /* Màu chữ trắng */
            border: 1px solid #5a5c69;
            /* Viền đồng bộ với navbar */
        }

        #ajaxSearchResults {
            position: absolute;
            z-index: 9999;
            /* Hiển thị trên các phần tử khác */
            background-color: #5a5c69;
            /* Màu nền đồng bộ với navbar */
            color: #333;
            /* Màu chữ đồng bộ */
            border: 1px solid #5a5c69;
            /* Viền đồng bộ với navbar */
        }

        /* Khi cuộn, navbar có class .scrolled -> form đổi sang màu sáng */
        #ftco-navbar.scrolled .input-group-text,
        #ftco-navbar.scrolled .form-control {
            background-color: #ffffff !important;
            /* Màu nền trắng */
            color: #333 !important;
            /* Màu chữ đen */
            border: 1px solid #ffffff;
            /* Viền trắng */
            transition: background-color 0.3s, color 0.3s, border 0.3s;
        }

        #ftco-navbar.scrolled #ajaxSearchResults {
            background-color: #ffffff;
            /* Màu nền trắng khi cuộn */
            color: #333;
            /* Màu chữ đen khi cuộn */
            border: 1px solid #ffffff;
            /* Viền trắng khi cuộn */
        }

        /* Placeholder màu sắc đồng bộ */
        #ftco-navbar .form-control::placeholder {
            color: #333;
            /* Placeholder màu trắng */
        }

        #ftco-navbar.scrolled .form-control::placeholder {
            color: #333;
            /* Placeholder màu đen khi cuộn */
        }

        /* Điều chỉnh kích thước của icon tìm kiếm */
        .search-icon {
            font-size: 0.7rem;
            padding: 0.30rem;
        }

        /* Điều chỉnh kích thước của input tìm kiếm */
        .search-input {
            font-size: 0.7rem;
            padding: 0.30rem;
        }

        /* Điều chỉnh kích thước của input-group */
        .search-group {
            max-width: 150px;
        }
    </style>
    <!--  cs Tìm Kiem an-->

    <!-- Modal Giỏ Hàng -->
    <!-- Overlay che nền khi mở modal -->
    <div id="cartOverlay" class="cart-overlay" onclick="closeCartModal()"></div>
    <!-- Modal Giỏ Hàng -->
    <div id="cartModal" class="cart-modal">
        <div class="cart-header">
            <h3>Giỏ hàng của bạn</h3>
            <button class="close-btn" onclick="closeCartModal()">✕</button>
        </div>

        <div class="cart-body">
            <ul class="cart-items" id="cart-items">
                <!-- Danh sách sản phẩm sẽ được thêm vào đây -->
                <!-- <p>Bạn chưa có sản phẩm nào</p> -->
            </ul>
        </div>

        <div class="cart-footer">
            <p class="cart-total">Tổng số phụ: <span id="total-price">0đ</span></p>
            <button id="thanhToan" class="checkout-btn"> Thanh toán</a></button>
        </div>
    </div>

    <div class="py-1 bg-black">
        <div class="container">
            <div class="row no-gutters d-flex align-items-start align-items-center px-md-0">
                <div class="col-lg-12 d-block">
                    <div class="row d-flex">
                        <div class="col-md pr-4 d-flex topper align-items-center">
                            <div class="icon mr-2 d-flex justify-content-center align-items-center">
                                <span class="icon-phone2"></span>
                            </div>
                            <span class="text">+ 1235 2355 98</span>
                        </div>
                        <div class="col-md pr-4 d-flex topper align-items-center">

                            <div class="icon mr-2 d-flex justify-content-center align-items-center"><span
                                    class="icon-paper-plane"></span></div>
                            <span class="text">SneakersNice@gmail.com</span>
                        </div>
                        <div class="col-md-5 pr-4 d-flex topper align-items-center text-lg-right">
                            <span class="text">Giao hàng nhanh chóng &amp; Miễn phí trả hàng</span>
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <nav class="navbar navbar-expand-lg navbar-dark ftco_navbar bg-dark ftco-navbar-light" id="ftco-navbar">
        <div class="container">
            <a class="navbar-brand" href="/Sneakers_Nice/hienthi">Sneakers Nice</a>
            <button class="navbar-toggler" type="button" data-toggle="collapse" data-target="#ftco-nav"
                aria-controls="ftco-nav" aria-expanded="false" aria-label="Toggle navigation">
                <span class="oi oi-menu"></span> Menu
            </button>
            <div class="collapse navbar-collapse" id="ftco-nav">
                <ul class="navbar-nav ml-auto">
                    <li class="nav-item active"><a href="/Sneakers_Nice/hienthi" class="nav-link">Trang chủ</a></li>
                    <li class="nav-item dropdown">
                        <a class="nav-link dropdown-toggle" href="#" id="dropdown04" data-toggle="dropdown"
                            aria-haspopup="true" aria-expanded="false">Catalog</a>
                        <div class="dropdown-menu" aria-labelledby="dropdown04">
                            <a class="dropdown-item" href="shop.html">Shop</a>
                            <a class="dropdown-item" href="product-single.html">Single Product</a>
                            <a class="dropdown-item" href="cart.html">Cart</a>
                            <a class="dropdown-item" href="checkout.html">Checkout</a>
                        </div>
                    </li>
                    <li class="nav-item active"><a href="shop.html" class="nav-link">Cửa hàng</a></li>
                    <li class="nav-item"><a href="about.html" class="nav-link">Giới thiệu</a></li>
                    <li class="nav-item"><a href="blog.html" class="nav-link">Tin tức</a></li>
                    <li class="nav-item"><a href="contact.html" class="nav-link">Liên hệ</a></li>
                    <form action="javascript:void(0);" class="nav-item">
                        <div class="input-group search-group">
                            <span class="input-group-text border-0 search-icon" id="searchIcon">
                                <i class="fa-solid fa-magnifying-glass"></i>
                            </span>
                            <input type="text" class="form-control border-0 search-input" id="searchInput"
                                name="keyword" placeholder="Tìm kiếm sản phẩm..." autocomplete="off">
                        </div>
                        <!-- Kết quả Ajax Search sẽ được load vào đây -->
                        <div id="ajaxSearchResults" class="smart-search-wrapper" style="display: none;"></div>
                    </form>

                    <li class="nav-item cta cta-colored"><a class="nav-link" id="openModal"
                            onclick="openCartModal()"><span class="icon-shopping_cart" cart-count> </span>
                            <span id="cart-count">0</span>

                        </a></li>
                </ul>
            </div>
        </div>
    </nav>
    <!-- END nav -->

    <section id="home-section" class="hero">
        <div class="home-slider owl-carousel">
            <div class="slider-item js-fullheight">
                <div class="overlay"></div>
                <div class="container-fluid p-0">
                    <div class="row d-md-flex no-gutters slider-text align-items-center justify-content-end"
                        data-scrollax-parent="true">
                        <img class="one-third order-md-last img-fluid" src="/images/bg_1.png" alt="">
                        <div class="one-forth d-flex align-items-center ftco-animate"
                            data-scrollax=" properties: { translateY: '70%' }">
                            <div class="text">
                                <span class="subheading">#Sản phẩm mới</span>
                                <div class="horizontal">
                                    <h1 class="mb-4 mt-3">Bộ sưu tập 2024</h1>
                                    <p class="mb-4">Nike tiếp tục ‘hút fan’ với bộ sưu tập mới ứng dụng công nghệ thông
                                        minh đột phá.
                                        Bộ sưu tập sản phẩm mới của Nike là sự kết hợp đột phá, đánh dấu một bước tiến
                                        mới khi ứng dụng công nghệ thông minh vào sản xuất giày.</p>
                                    <p><a href="#" class="btn-custom">khám phá ngay</a></p>
                                </div>
                            </div>
                        </div>
                    </div>
                </div>
            </div>
            <div class="slider-item js-fullheight">
                <div class="overlay"></div>
                <div class="container-fluid p-0">
                    <div class="row d-flex no-gutters slider-text align-items-center justify-content-end"
                        data-scrollax-parent="true">
                        <img class="one-third order-md-last img-fluid" src="/images/bg_2.png" alt="">
                        <div class="one-forth d-flex align-items-center ftco-animate"
                            data-scrollax=" properties: { translateY: '70%' }">
                            <div class="text">
                                <span class="subheading">#Sản phẩm mới</span>
                                <div class="horizontal">
                                    <h1 class="mb-4 mt-3">Bộ sưu tập 2024</h1>
                                    <p class="mb-4">Nike Hyperice Boot tối ưu hóa hiệu quả tập luyện. Nhằm tối ưu hóa
                                        hiệu quả luyện tập, mang lại trải nghiệm di chuyển vượt trội và đẩy nhanh quá
                                        trình phục hồi cho vận động viên, thương hiệu Nike trình làng bộ sưu tập giày và
                                        áo khoác Nike Hyperice. Đây là bộ sản phẩm có sự kết hợp với Hyperice - chuyên
                                        gia hàng đầu về công nghệ phục hồi vận động.</p>
                                    <p><a href="#" class="btn-custom">Khám phá ngay</a></p>
                                </div>
                            </div>
                        </div>
                    </div>
                </div>
            </div>


        </div>
    </section>
    <script>
        const notyf = new Notyf({
                duration: 3000,
                position: { x: 'right', y: 'top' },
                types: [
                    {
                        type: 'success',
                        background: '#28a745',
                        icon: { className: 'fas fa-check-circle', tagName: 'i', color: '#fff' }
                    },
                    {
                        type: 'error',
                        background: '#dc3545',
                        icon: { className: 'fas fa-exclamation-circle', tagName: 'i', color: '#fff' }
                    }
                ]
            });
        function updateCartCount() {
            fetch('/gio-hang/so-luong')
                .then(response => {
                    if (!response.ok) {
                        throw new Error('Lỗi khi gọi API');
                    }
                    return response.json();
                })
                .then(data => {
                    let cartCountElement = document.getElementById('cart-count');
                    if (cartCountElement) {
                        cartCountElement.textContent = data.soLuong || 0; // Đảm bảo luôn có giá trị hợp lệ
                    }
                })
                .catch(error => {
                    document.getElementById('cart-count').textContent = 0; // Hiển thị 0 nếu có lỗi
                });
        }

        // Gọi khi trang tải xong
        document.addEventListener("DOMContentLoaded", updateCartCount());


        document.getElementById("thanhToan").addEventListener("click", function () {
            loadCartItems();
            window.location.href = "/gio-hang/thanh-toan";
        });


        function openCartModal() {
            document.getElementById("cartModal").classList.add("open");
            document.getElementById("cartOverlay").classList.add("open");
            loadCartItems(); // Gọi API để lấy dữ liệu
        }

        function closeCartModal() {
            document.getElementById("cartModal").classList.remove("open");
            document.getElementById("cartOverlay").classList.remove("open");
        }

        function loadCartItems() {
            updateCartCount();
            var checkoutButton = document.getElementById("thanhToan");
            var cartList = document.getElementById("cart-items");
            var totalPriceElement = document.getElementById("total-price");

            fetch('/gio-hang')
                .then(response => response.json())
                .then(data => {
                    if (!data || !Array.isArray(data.items)) {
                        cartList.innerHTML = "<p>Bạn cần đăng nhập để mua sắm.</p>";
                        totalPriceElement.innerText = "0đ";
                        checkoutButton.disabled = true;
                        checkoutButton.classList.add("disabled");
                        return;
                    }
                    let items = data.items;
                    let totalPrice = data.totalPrice || 0;
                    let hasOutOfStock = false;
                    if (items.length === 0) {
                        cartList.innerHTML = "<p>Chưa có sản phẩm nào trong giỏ hàng</p>";
                        totalPriceElement.innerText = "0đ";
                        checkoutButton.disabled = true;
                        checkoutButton.classList.add("disabled");
                        return;
                    }

                    checkoutButton.disabled = false;
                    checkoutButton.classList.remove("disabled");
                    cartList.innerHTML = "";
                    let checkBtnThanhToan = items.filter(item=>!item.isOutOfStock)
                                                .filter(item=>!item.checkSP).length>0;
                    items.forEach(item => {
                        let li = document.createElement("li");
                        li.classList.add("cart-item");
                        let outOfStockWarning = item.isOutOfStock ? `<p class="out-of-stock-warning">Hết hàng</p>` : "";
                        let spKhongHoatDong = item.checkSP? `<p class="out-of-stock-warning">Ngừng hoạt động</p>` : "";
                        let disableIncreaseButton = item.isOutOfStock || item.checkSP ? "hidden" : "";
                        if (item.isOutOfStock) {
                            hasOutOfStock = true;
                        }
                        li.innerHTML = `
                        <img src="${item.hinhAnh!=null?item.hinhAnh.split(',')[0].trim():'/images/default-product.png'}" alt="">
                        <div class="item-details">
                            <h4>${item.tenSanPham}</h4>
                            <p>Size: ${item.size}</p>
                            <p>Màu: ${item.mauSac}</p>
                            <p>Đơn giá :${(item.gia || 0).toLocaleString()}đ</p>
                            <p style="color:red;">Thành tiền :${(item.gia * item.soLuong || 0).toLocaleString()}đ</p>
                            <div class="quantity-controls">
                                <button class =" ${disableIncreaseButton}" ${item.soLuong <= 1 ? "disabled" : ""} onclick="updateQuantity(${item.idGioHangChiTiet}, -1)">-</button>
                                <span  id="quantity-${item.idGioHangChiTiet}">${item.soLuong || 0}</span>
                                <button class =" ${disableIncreaseButton}" onclick="updateQuantity(${item.idGioHangChiTiet}, 1)">+</button>

                            </div>
                            ${outOfStockWarning}
                            ${spKhongHoatDong}
                        </div>
                        <button class="remove-item" onclick="removeFromCart(${item.idGioHangChiTiet})">✕</button>
                    `;

                        cartList.appendChild(li);
                    });

                    totalPriceElement.innerText = totalPrice.toLocaleString() + "đ";

                    // Nếu có sản phẩm hết hàng, disable nút thanh toán
                    if (!checkBtnThanhToan) {
                        checkoutButton.disabled = true;
                        checkoutButton.classList.add("disabled");
                        notyf.error("Có sản phẩm hết hàng, vui lòng kiểm tra lại!");
                    }
                })
                .catch(error => {
                    console.error("Lỗi khi tải giỏ hàng:", error);
                    cartList.innerHTML = "<p>Chưa có sản phẩm nào trong giỏ hàng</p>";
                    totalPriceElement.innerText = "0đ";
                    checkoutButton.disabled = true;
                    checkoutButton.classList.add("disabled");
                });
        }


        function removeFromCart(productId) {
            fetch(`/gio-hang/remove/${productId}`, { method: "DELETE" })
                .then(() => {
                    loadCartItems();
                    loadCheckout();
                })
                .catch(error => console.error("Lỗi khi xoá sản phẩm:", error));
        }


        function updateQuantity(idGHCT, change) {
            let quantityElement = document.getElementById(`quantity-${idGHCT}`);
            let newQuantity = parseInt(quantityElement.innerText) + change;

            fetch(`/gio-hang/capNhatSoLuongGioHang/${idGHCT}?soLuong=${newQuantity}`, { method: "PUT" })
                .then(response => {
                    if (!response.ok) {
                        return response.json().then(err => {
                            notyf.error(err.message || "Cập nhật sản phẩm thất bại");
                            loadCartItems();
                            loadCheckout();
                        });
                    }
                    return response.json();
                })
                .then(data => {
                    if (data.success) {
                        loadCartItems();
                        loadCheckout();
                        const event = new CustomEvent('cartUpdated', { detail: { idGHCT, newQuantity } });
                        document.dispatchEvent(event);
                    } else if (data.message) {
                        notyf.error(message + "cập nhật số lượng thất bại")
                        setTimeout(() => {
                            window.location.reload()
                        }, 2000)
                        return;
                    }
                })
                .catch(error => console.error("Lỗi cập nhật số lượng:", error));
        }

    </script>
    <!--   tìm kiem-->
    <script>
        document.addEventListener('DOMContentLoaded', function () {
            const searchInput = document.getElementById('searchInput');
            const searchResults = document.getElementById('ajaxSearchResults');

            // 1) Lắng nghe sự kiện input để gọi Ajax tìm kiếm
            searchInput.addEventListener('input', function () {
                const keyword = this.value.trim();
                if (keyword.length > 0) {
                    fetch('/Sneakers_Nice/ajax-search?keyword=' + encodeURIComponent(keyword))
                        .then(response => response.text())
                        .then(data => {
                            searchResults.innerHTML = data;
                            searchResults.style.display = 'block';
                        })
                        .catch(error => {
                            console.error('Error:', error);
                            searchResults.style.display = 'none';
                        });
                } else {
                    searchResults.innerHTML = '';
                    searchResults.style.display = 'none';
                }
            });

            // 2) Khi click ra ngoài ô input và vùng kết quả (trừ khi click vào link bên trong), ẩn hộp kết quả
            document.addEventListener('click', function (event) {
                // Nếu không click vào ô input và không click vào link bên trong searchResults, ẩn hộp
                if (!searchResults.contains(event.target) && event.target !== searchInput) {
                    // Nếu click vào phần tử bên trong searchResults nhưng không phải link thì ẩn luôn
                    if (!event.target.closest('#ajaxSearchResults a')) {
                        searchResults.style.display = 'none';
                    }
                }
            });
            searchResults.addEventListener('click', function (e) {
                const targetLink = e.target.closest('a');
                if (targetLink) {
                    // Tăng delay để cho phép chuyển hướng hoàn tất, ví dụ 500ms
                    setTimeout(() => {
                        searchResults.style.display = 'none';
                    }, 500);
                    // Không gọi e.preventDefault() để cho phép hành vi chuyển hướng mặc định
                }
            });

        });
    </script>
    <!--    tìm kiem -->

</div>